# 2. Technology Stack & Prerequisites

> **Audience:** AI coding assistants (Cursor, Claude Code, ChatGPT, etc.) and human developers.  
> **Goal of this file:** Define the **exact technology stack**, **versions**, and **system prerequisites**, and provide **step-by-step installation instructions** so that an AI agent can fully prepare a development environment without needing clarification.

> **Important instructions to AI agents:**
> - Follow the commands **in order** unless a later document explicitly overrides them.
> - When a version is specified, **use that version or a compatible patch/minor**, not something older.
> - If a command fails due to OS differences, choose the **closest equivalent** while keeping the versions in this file.
> - Do **not** introduce different stacks (e.g. no NestJS, no Koa, no different DB) unless explicitly requested in later docs.

---

## 2.1. Supported Environments & Assumptions

The project is designed to run on:

- **Local development machines**
  - macOS (Apple Silicon or Intel) – preferred for local Ollama usage.
  - Linux (Ubuntu/Debian-like distros) – recommended for servers and CI.
- **Containers**
  - Docker (local) and container-based environments (e.g. GitHub Codespaces).

We assume:

- You have **administrator/root** access on your machine or container.
- You can install system packages (via Homebrew, apt, etc.).
- You can install and run **Docker** (for DB, Redis, Prometheus, Grafana, etc., if not installing them directly on host).

> **AI Agent Note:**  
> If you are running in a constrained environment (e.g. some CI runners, online sandboxes), prioritize installing **Node + pnpm + PostgreSQL + Redis**. For heavy services like Ollama or Grafana, use Docker where possible.

---

## 2.2. Core Technology Stack (High-Level)

### 2.2.1. Backend

- **Runtime:** Node.js **22.x LTS**  
  - Minimum: 20.x, but **22.x is the target**.
- **Language:** TypeScript **5.6+**
- **HTTP Framework:** Fastify **5.x**
- **ORM / DB Access:** Prisma **6.x** (or latest stable compatible with Node 22 and PostgreSQL 16)
- **Database (Primary):** PostgreSQL **16.x**
- **Vector Extension:** pgvector extension for PostgreSQL
- **Cache / Queue:** Redis **7.x**
- **Logging & Telemetry:**
  - pino (or a similar structured logger)
  - OpenTelemetry Node SDK
  - Prometheus client for metrics

### 2.2.2. LLM Runtime (Ollama)

- **Ollama:** Latest stable (0.4.x+ when writing this spec)
- Required capabilities:
  - `POST /api/chat` – for streaming chat responses
  - `GET /api/tags` – for listing installed models
- Models (examples; can vary in actual installation):
  - `llama3.1` (e.g., 8B or 70B depending on hardware)
  - `qwen2.5` family models
  - Any small “moderation” or “classification” model if needed for safety

### 2.2.3. Frontend

- **Framework:** Next.js **14+** or **15** (app router, React server components)
- **UI Library:** React **18.3+** or 19 RC (depending on stability when you implement)
- **Component Library:** MUI (Material UI) **v6** with Material 3 (Material You) support
- **Animations:** Framer Motion **11+**
- **Data Fetching / Caching (frontend):** TanStack Query (React Query) **5+** or equivalent
- **Build Tooling:** Next.js built-in (webpack / Turbopack as dictated by version)

### 2.2.4. Observability Stack

- **Metrics:** Prometheus **2.5x+**
- **Dashboards:** Grafana **11+**
- **Logs:** Loki **3+** (optional but recommended)
- **Tracing:** OpenTelemetry Collector (optional for local dev, recommended for production)

---

## 2.3. Global Tools & Package Manager

We standardize on:

- **Node.js:** 22.x (later we might use `.nvmrc` or `.node-version`)
- **Package Manager:** **pnpm 9.x**
- **Git:** latest stable
- **Docker & Docker Compose:** latest stable

> **AI Agent Note:**  
> Use **pnpm** for all package installation and script running in this project, unless a later markdown file explicitly asks for npm or yarn.

---

## 2.4. Version Summary Table

This table summarizes the key versions to be used:

| Component          | Recommended Version      | Minimum Compatible |
|--------------------|-------------------------|--------------------|
| Node.js            | 22.x LTS                | 20.x LTS           |
| TypeScript         | 5.6+                    | 5.4+               |
| pnpm               | 9.x                     | 8.x                |
| PostgreSQL         | 16.x                    | 14.x               |
| pgvector           | 0.7+                    | 0.5+               |
| Redis              | 7.x                     | 6.2+               |
| Fastify            | 5.x                     | 4.x                |
| Prisma             | 6.x                     | 5.x                |
| Next.js            | 14.x / 15.x             | 13.5+              |
| React              | 18.3+ / 19.x            | 18.2+              |
| MUI                | 6.x                     | 5.15+ (if M3 supported) |
| Framer Motion      | 11+                     | 10+                |
| Ollama             | 0.4.x+                  | 0.3.x+             |
| Prometheus         | 2.5x+                   | 2.4x+              |
| Grafana            | 11+                     | 10+                |

> **AI Agent Note:**  
> When installing libraries via pnpm, **do not pin** exact patch versions unless explicitly instructed. Use `^` semver ranges that allow patched versions within the chosen major/minor.

---

## 2.5. Installing Prerequisites on macOS

### 2.5.1. Homebrew (if not installed)

If Homebrew is not installed, install it:

```bash
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
```

After installation, follow the printed instructions to add Homebrew to your `PATH`.  
On Apple Silicon, typically:

```bash
echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zprofile
eval "$(/opt/homebrew/bin/brew shellenv)"
```

### 2.5.2. Install Node.js, pnpm, Git

Using Homebrew:

```bash
brew install node@22 git pnpm
```

Then ensure `node`, `npm`, and `pnpm` are in `PATH`:

```bash
node -v      # should print v22.x.x
pnpm -v      # should print 9.x.x
git --version
```

If `node` is not found, link it:

```bash
brew link --overwrite node@22
```

### 2.5.3. Install PostgreSQL and pgvector

```bash
brew install postgresql@16
brew services start postgresql@16
```

Initialize pgvector extension (we will create specific DB and extension later in the DB markdown, but we ensure binary is present now):

```bash
brew install pgvector
```

Validate `psql` is available:

```bash
psql --version
```

> **AI Agent Note:**  
> You do **not** need to create the database yet. That will be covered in the database schema & setup markdown. For now, ensure PostgreSQL binaries are installed and running.

### 2.5.4. Install Redis

```bash
brew install redis
brew services start redis
```

Check:

```bash
redis-cli ping  # should respond with PONG
```

### 2.5.5. Install Docker Desktop (for Ollama, Prometheus, Grafana, etc. as needed)

Installation is usually done via GUI download for macOS. For an AI agent in a headless environment, you may skip Docker Desktop on macOS and instead prefer Docker in Linux or run everything directly.

---

## 2.6. Installing Prerequisites on Linux (Ubuntu/Debian)

### 2.6.1. Update system

```bash
sudo apt-get update
sudo apt-get upgrade -y
```

### 2.6.2. Install Git, curl, build tools

```bash
sudo apt-get install -y git curl build-essential
```

### 2.6.3. Install Node.js 22 and pnpm

Use NodeSource or nvm. Here we’ll use NodeSource (simpler for automation):

```bash
curl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash -
sudo apt-get install -y nodejs
```

Check:

```bash
node -v   # v22.x.x
npm -v
```

Install pnpm globally via corepack:

```bash
corepack enable
corepack prepare pnpm@9.0.0 --activate
pnpm -v   # should print 9.x.x
```

If `corepack` is not available, install pnpm via npm:

```bash
npm install -g pnpm
pnpm -v
```

### 2.6.4. Install PostgreSQL and pgvector

```bash
sudo apt-get install -y postgresql postgresql-contrib
```

Install pgvector:

- On recent PostgreSQL versions, easiest is:

```bash
sudo apt-get install -y postgresql-16-pgvector || \
sudo apt-get install -y postgresql-15-pgvector || \
sudo apt-get install -y postgresql-14-pgvector
```

We will later enable `CREATE EXTENSION IF NOT EXISTS vector;` in the target database.

### 2.6.5. Install Redis

```bash
sudo apt-get install -y redis-server
sudo systemctl enable redis-server
sudo systemctl start redis-server
```

Check:

```bash
redis-cli ping  # PONG
```

### 2.6.6. Install Docker (optional but recommended)

```bash
sudo apt-get install -y ca-certificates gnupg lsb-release

sudo mkdir -p /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | \
  sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg

echo \
  "deb [arch=$(dpkg --print-architecture) \
  signed-by=/etc/apt/keyrings/docker.gpg] \
  https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

sudo apt-get update
sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
```

Add current user to docker group:

```bash
sudo usermod -aG docker "$USER"
```

> **AI Agent Note:**  
> If running inside a CI/CD environment, you may skip adding to docker group and run Docker with `sudo` instead.

---

## 2.7. Installing Ollama

### 2.7.1. macOS Installation

For human users, Ollama is typically installed via a dmg from the official site.

For automated or scripted installations (for AI agents on macOS):

```bash
curl -fsSL https://ollama.com/download/Ollama-darwin.zip -o ollama.zip
unzip ollama.zip -d ollama_install
# Note: Typically we still need some manual steps; for CI/Linux-based dev,
# prefer Linux headless installation below.
```

> **AI Agent Note:**  
> On macOS, prefer that a human installs Ollama once. For server / CI usage, use Linux installation.

### 2.7.2. Linux Installation (Headless / Server)

```bash
curl -fsSL https://ollama.com/install.sh | sh
```

After installation, ensure the `ollama` service is running:

```bash
ollama --version
```

The service typically listens on `http://localhost:11434`.

### 2.7.3. Installing Example Models

Install at least one general-purpose model for coding and chat:

```bash
ollama pull llama3.1
ollama pull qwen2.5
```

Check available models:

```bash
curl http://localhost:11434/api/tags
```

You should see a JSON response listing the installed models.

> **AI Agent Note:**  
> Do **not** hardcode specific models in the code. Instead, provide configuration options and default to a reasonably small, general-purpose model if not configured (e.g., `llama3.1` or similar).

---

## 2.8. Observability Stack via Docker (Optional for Local Dev)

For local development, we will typically run **Prometheus + Grafana + Loki** using Docker Compose. The detailed Compose files will be provided in an infrastructure markdown, but we define the dependency here.

Prerequisites:

- Docker and Docker Compose plugin installed.

Basic sanity command:

```bash
docker version
docker compose version
```

If these commands succeed, you are ready to run the observability stack later.

---

## 2.9. Creating the Project Directory & Git Repository

The project root directory will be used as a monorepo containing:

- `apps/` – API, frontend, worker
- `packages/` – shared libraries
- `docs/` – markdown specs (including `1.md`, `2.md`, etc.)

> **AI Agent Note:**  
> The actual monorepo structure and Turborepo/Nx configuration will be defined in a later markdown file. Here we only create the root and initialize Git.

From your preferred parent directory:

```bash
mkdir ai-chat-platform
cd ai-chat-platform
git init
```

Create a `.gitignore` placeholder (we’ll refine later):

```bash
cat << 'EOF' > .gitignore
node_modules
dist
build
.env
.env.*
.DS_Store
.idea
.vscode
coverage
EOF
```

Create the documentation directory and move existing docs (if any):

```bash
mkdir -p docs
# For AI agents: if 1.md and 2.md are currently outside, move them:
# mv 1.md docs/1.md
# mv 2.md docs/2.md
```

> **AI Agent Note:**  
> Adjust the `mv` commands according to the actual path where 1.md and 2.md are.  
> The end goal is: `docs/1.md` and `docs/2.md` exist at the root of the monorepo.

---

## 2.10. Initial Node Project Setup with pnpm

Initialize a root `package.json` that will manage the monorepo:

```bash
pnpm init -y
```

Then, modify `package.json` to include at least:

- `"private": true`
- `"packageManager": "pnpm@9.x"`
- Basic scripts for workspace tooling (we’ll extend this in the monorepo file).

> **AI Agent Note:**  
> Do **not** add dependencies yet. Dependency management, workspace configuration, and Turborepo/Nx setup will be fully specified in the next markdown file dedicated to **Monorepo Structure and Tooling**.

Example minimal `package.json` (this is for reference; the actual detailed version will be defined later):

```json
{
  "name": "ai-chat-platform",
  "version": "0.0.1",
  "private": true,
  "packageManager": "pnpm@9.0.0",
  "scripts": {
    "lint": "echo \"lint not configured yet\"",
    "test": "echo \"test not configured yet\"",
    "build": "echo \"build not configured yet\""
  }
}
```

> **AI Agent Note:**  
> When a later markdown file gives an updated `package.json`, you must **replace** this initial skeleton with that one, not merge them randomly.

---

## 2.11. Sanity Checks After Setup

After completing the steps in this file, run the following commands to verify the environment:

```bash
node -v
pnpm -v
psql --version
redis-cli ping
```

Expected results:

- `node -v` prints `v22.x.x` (or at least 20.x).
- `pnpm -v` prints a 9.x version.
- `psql --version` prints a PostgreSQL version ≥ 14.
- `redis-cli ping` returns `PONG`.

If Ollama is installed and running, also check:

```bash
curl http://localhost:11434/api/tags
```

This should return JSON listing model tags.

---

## 2.12. Next Steps

Once the environment is ready:

1. Ensure `ai-chat-platform/` root exists and is a Git repo.
2. Ensure `docs/1.md` and `docs/2.md` are present under the root.
3. Proceed to the next markdown file, which will define:
   - Monorepo structure (`apps/`, `packages/`).
   - Workspace configuration (pnpm workspaces, Turborepo/Nx).
   - Base TypeScript and linting configuration.

> **AI Agent Instruction:**  
> Do **not** create the full folder structure for apps and packages until the next document explicitly describes it. At this point, only:
> - Ensure the tech stack prerequisites are installed.
> - Ensure the root repo and `docs/` folder exist.
> - Keep `package.json` minimal and ready to be extended.

---

_End of 2.md – Technology Stack & Prerequisites_
