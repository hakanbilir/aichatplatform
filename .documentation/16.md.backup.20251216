# 16. Org‑Level Analytics & Admin Dashboard

> **Audience:** AI coding assistants (Cursor, Claude Code, ChatGPT, etc.) and human developers.  
> **Goal of this file:** Add an **org‑level usage analytics layer** and a **Grafana‑inspired analytics UI**:
>
> - Backend: `GET /orgs/:id/usage` endpoint that aggregates usage across all conversations in an org.  
> - Frontend API: `getOrgUsageSummary(...)`.  
> - Frontend UI: a Material‑3, vivid‑gradient, micro‑interactive **Org Analytics page** with charts and chips.  
> - Time‑window selector (7 / 30 / 90 days) with live chart updates.
>
> After following this file, org owners/admins will see **per‑org token usage and completions over time**, similarly to an internal billing/analytics console.

> **Important instructions to AI agents:**
> - This file builds on: `11.md` (metrics), `13.md` (RBAC), `15.md` (per‑conversation usage).  
> - Treat all code here as **canonical** when it conflicts with earlier drafts.  
> - Do **not** add TODOs or placeholders; everything must be fully implemented.

---

## 16.1. Analytics Model – What We Aggregate

We define **org‑level usage** as the sum of all assistant completions in conversations that belong to a given org.

Data source:

- `message.meta.usage` (from `11.md` and `15.md`), where:
  - `usage.promptTokens: number`  
  - `usage.completionTokens: number`
- We only consider messages where:
  - `message.role === 'ASSISTANT'`  
  - `message.conversation.orgId === :orgId`

We compute:

- `totalPromptTokens` – sum of all `usage.promptTokens` in range.  
- `totalCompletionTokens` – sum of all `usage.completionTokens` in range.  
- `totalTokens = totalPromptTokens + totalCompletionTokens`.  
- `completions` – number of assistant messages in range with a `usage` object.  
- `byDay[]` – per‑day aggregation within a window (7 / 30 / 90 days), based on `message.createdAt`.

---

## 16.2. Backend – `/orgs/:id/usage` Endpoint

We create a dedicated route module for org analytics.

### 16.2.1. Create `apps/api-gateway/src/routes/org-analytics.ts`

```ts
// apps/api-gateway/src/routes/org-analytics.ts

import { FastifyInstance, FastifyPluginOptions } from 'fastify';
import { prisma } from '@ai-chat/db';
import { JwtPayload } from '../auth/types';
import { z } from 'zod';
import { assertOrgPermission } from '../rbac/guards';

const usageQuerySchema = z.object({
  days: z
    .string()
    .optional()
    .transform((value) => {
      if (!value) return 30;
      const n = Number(value);
      if (!Number.isFinite(n) || n <= 0) return 30;
      if (n > 365) return 365;
      return Math.round(n);
    })
});

export default async function orgAnalyticsRoutes(app: FastifyInstance, _opts: FastifyPluginOptions) {
  // Org‑level usage summary (aggregated across all conversations in the org)
  app.get('/orgs/:id/usage', { preHandler: [app.authenticate] }, async (request, reply) => {
    const payload = request.user as JwtPayload;

    const paramsSchema = z.object({ id: z.string().min(1) });
    const parseParams = paramsSchema.safeParse(request.params);
    if (!parseParams.success) {
      return reply.code(400).send({ error: 'Invalid org id' });
    }
    const orgId = parseParams.data.id;

    const parseQuery = usageQuerySchema.safeParse(request.query);
    if (!parseQuery.success) {
      return reply.code(400).send({ error: 'Invalid query', details: parseQuery.error.format() });
    }

    const days = parseQuery.data.days;

    // Enforce RBAC – must have analytics:view on this org
    await assertOrgPermission(
      { id: payload.userId, isSuperadmin: payload.isSuperadmin },
      orgId,
      'analytics:view'
    );

    // Time window
    const now = new Date();
    const from = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);

    // Fetch ASSISTANT messages for this org in the time window
    const messages = await prisma.message.findMany({
      where: {
        role: 'ASSISTANT',
        createdAt: {
          gte: from
        },
        conversation: {
          orgId
        }
      },
      select: {
        meta: true,
        createdAt: true
      },
      orderBy: {
        createdAt: 'asc'
      }
    });

    let totalPromptTokens = 0;
    let totalCompletionTokens = 0;
    let completions = 0;
    let firstMessageAt: Date | null = null;
    let lastMessageAt: Date | null = null;

    // Prepare per‑day buckets
    const buckets = new Map<string, { promptTokens: number; completionTokens: number; totalTokens: number }>();

    for (const m of messages) {
      const meta: any = m.meta ?? {};
      const usage = meta?.usage;

      if (!usage || typeof usage !== 'object') {
        continue;
      }

      const promptTokens = typeof usage.promptTokens === 'number' ? usage.promptTokens : 0;
      const completionTokens = typeof usage.completionTokens === 'number' ? usage.completionTokens : 0;

      const totalTokens = promptTokens + completionTokens;

      totalPromptTokens += promptTokens;
      totalCompletionTokens += completionTokens;
      completions += 1;

      if (!firstMessageAt || m.createdAt < firstMessageAt) {
        firstMessageAt = m.createdAt;
      }
      if (!lastMessageAt || m.createdAt > lastMessageAt) {
        lastMessageAt = m.createdAt;
      }

      const dayKey = m.createdAt.toISOString().slice(0, 10); // YYYY-MM-DD
      const existing = buckets.get(dayKey) ?? {
        promptTokens: 0,
        completionTokens: 0,
        totalTokens: 0
      };

      existing.promptTokens += promptTokens;
      existing.completionTokens += completionTokens;
      existing.totalTokens += totalTokens;

      buckets.set(dayKey, existing);
    }

    const byDay = Array.from(buckets.entries())
      .sort(([a], [b]) => (a < b ? -1 : a > b ? 1 : 0))
      .map(([date, stats]) => ({
        date,
        promptTokens: stats.promptTokens,
        completionTokens: stats.completionTokens,
        totalTokens: stats.totalTokens
      }));

    const totals = {
      promptTokens: totalPromptTokens,
      completionTokens: totalCompletionTokens,
      totalTokens: totalPromptTokens + totalCompletionTokens
    };

    return reply.send({
      orgId,
      range: {
        from,
        to: now,
        days
      },
      totals,
      completions,
      firstMessageAt,
      lastMessageAt,
      byDay
    });
  });
}
```

This route:

- Validates `:id` and `days` (defaults to 30).  
- Enforces RBAC with `analytics:view`.  
- Aggregates per‑day usage and totals.  
- Returns data suitable for charting.

---

## 16.3. Register Org Analytics Routes in `main.ts`

We must register the new route module in the API gateway.

### 16.3.1. Update `apps/api-gateway/src/main.ts`

Replace the imports and route registrations section with the following, preserving everything else (logging, CORS, health, metrics, auth plugin):

```ts
import fastify from 'fastify';
import cors from 'fastify-cors';
import { getConfig } from '@ai-chat/config';
import { ensureDbExtensions, checkDbConnection } from '@ai-chat/db';
import authPlugin from './plugins/auth';
import metricsPlugin from './plugins/metrics';
import authRoutes from './routes/auth';
import orgRoutes from './routes/orgs';
import orgAnalyticsRoutes from './routes/org-analytics';
import conversationsRoutes from './routes/conversations';
import chatRoutes from './routes/chat';

async function buildServer() {
  const config = getConfig();

  const app = fastify({
    logger: {
      level: config.LOG_LEVEL
    }
  });

  await app.register(cors, {
    origin: true,
    credentials: true
  });

  // Metrics plugin (adds /metrics and HTTP request metrics)
  await app.register(metricsPlugin);

  // Health check route (no auth)
  app.get('/health', async () => {
    const dbOk = await checkDbConnection();
    return {
      status: 'ok',
      env: config.NODE_ENV,
      db: dbOk ? 'up' : 'down',
      defaultModel: config.DEFAULT_MODEL
    };
  });

  // Auth plugin (JWT + authenticate hook)
  await app.register(authPlugin);

  // Routes
  await app.register(authRoutes);
  await app.register(orgRoutes);
  await app.register(orgAnalyticsRoutes);
  await app.register(conversationsRoutes);
  await app.register(chatRoutes);

  // Ensure DB extensions
  await ensureDbExtensions();

  return app;
}

async function start() {
  const config = getConfig();
  const port = config.API_PORT;
  const host = config.API_HOST;

  const app = await buildServer();

  app
    .listen({ port, host })
    .then(() => {
      app.log.info(`API Gateway listening on http://${host}:${port}`);
    })
    .catch((err) => {
      app.log.error(err, 'Failed to start API Gateway');
      process.exit(1);
    });
}

start();
```

If `main.ts` already matches this structure from `11.md`, only the `import orgAnalyticsRoutes` and `await app.register(orgAnalyticsRoutes);` lines are newly added.

---

## 16.4. Frontend API – `getOrgUsageSummary`

We create a dedicated API module for org analytics on the frontend.

### 16.4.1. Create `apps/web/src/api/orgAnalytics.ts`

```ts
// apps/web/src/api/orgAnalytics.ts

import { apiRequest } from './client';

export interface OrgUsageDayBucket {
  date: string; // YYYY-MM-DD
  promptTokens: number;
  completionTokens: number;
  totalTokens: number;
}

export interface OrgUsageRange {
  from: string;
  to: string;
  days: number;
}

export interface OrgUsageSummary {
  orgId: string;
  range: OrgUsageRange;
  totals: {
    promptTokens: number;
    completionTokens: number;
    totalTokens: number;
  };
  completions: number;
  firstMessageAt: string | null;
  lastMessageAt: string | null;
  byDay: OrgUsageDayBucket[];
}

export async function getOrgUsageSummary(
  token: string,
  orgId: string,
  days: number
): Promise<OrgUsageSummary> {
  const search = new URLSearchParams({ days: String(days) }).toString();
  return apiRequest<OrgUsageSummary>(`/orgs/${orgId}/usage?${search}`, { method: 'GET' }, token);
}
```

---

## 16.5. Frontend Dependency – Charts Library

We use **Recharts** for a lightweight analytics chart.

### 16.5.1. Update `apps/web/package.json`

Add `recharts` to `dependencies`:

```jsonc
{
  "name": "web",
  "version": "0.1.0",
  "private": true,
  "dependencies": {
    // ...existing deps...
    "recharts": "^2.12.7"
  }
}
```

From the repo root:

```bash
pnpm install
```

---

## 16.6. Org Analytics Page – UI & Micro‑Interactions

We now add a dedicated Org Analytics page using Material‑3‑style components and a Grafana‑inspired look.

> **Assumption:** The router will mount this page at `/orgs/:orgId/analytics`.  
> You can wire it into `react-router` separately (e.g., in `AppRoutes.tsx`).

### 16.6.1. Create `apps/web/src/orgs/OrgAnalyticsPage.tsx`

```tsx
// apps/web/src/orgs/OrgAnalyticsPage.tsx

import React, { useEffect, useMemo, useState } from 'react';
import {
  Box,
  Typography,
  ToggleButton,
  ToggleButtonGroup,
  Card,
  CardContent,
  Chip,
  CircularProgress,
  Tooltip
} from '@mui/material';
import InsightsIcon from '@mui/icons-material/Insights';
import TimelineIcon from '@mui/icons-material/Timeline';
import GrainIcon from '@mui/icons-material/Grain';
import { useAuth } from '../auth/AuthContext';
import { OrgUsageDayBucket, OrgUsageSummary, getOrgUsageSummary } from '../api/orgAnalytics';
import {
  LineChart,
  Line,
  XAxis,
  YAxis,
  Tooltip as RechartsTooltip,
  ResponsiveContainer,
  CartesianGrid,
  Legend
} from 'recharts';
import { useParams } from 'react-router-dom';

function formatNumber(n: number): string {
  if (n >= 1_000_000) return `${(n / 1_000_000).toFixed(1)}M`;
  if (n >= 1_000) return `${(n / 1_000).toFixed(1)}k`;
  return String(n);
}

function formatDateLabel(date: string): string {
  // date: YYYY-MM-DD
  return date.slice(5); // MM-DD
}

export const OrgAnalyticsPage: React.FC = () => {
  const { token } = useAuth();
  const { orgId } = useParams<{ orgId: string }>();

  const [days, setDays] = useState<number>(30);
  const [summary, setSummary] = useState<OrgUsageSummary | null>(null);
  const [loading, setLoading] = useState<boolean>(false);
  const [error, setError] = useState<string | null>(null);

  const handleChangeDays = (_: React.MouseEvent<HTMLElement>, value: number | null) => {
    if (!value) return;
    setDays(value);
  };

  useEffect(() => {
    if (!token || !orgId) {
      setSummary(null);
      return;
    }

    let cancelled = false;

    async function load() {
      setLoading(true);
      setError(null);
      try {
        const data = await getOrgUsageSummary(token, orgId, days);
        if (!cancelled) {
          setSummary(data);
        }
      } catch (err) {
        if (!cancelled) {
          setError((err as Error).message || 'Failed to load org usage');
          setSummary(null);
        }
      } finally {
        if (!cancelled) {
          setLoading(false);
        }
      }
    }

    load();

    return () => {
      cancelled = true;
    };
  }, [token, orgId, days]);

  const chartData = useMemo<OrgUsageDayBucket[]>(() => {
    if (!summary) return [];
    return summary.byDay;
  }, [summary]);

  const totalTokens = summary?.totals.totalTokens ?? 0;
  const totalPromptTokens = summary?.totals.promptTokens ?? 0;
  const totalCompletionTokens = summary?.totals.completionTokens ?? 0;
  const completions = summary?.completions ?? 0;

  return (
    <Box
      display="flex"
      flexDirection="column"
      flex={1}
      sx={{
        p: 2,
        gap: 2,
        background:
          'radial-gradient(circle at top left, rgba(124,77,255,0.18), transparent 55%), radial-gradient(circle at bottom right, rgba(3,218,198,0.12), transparent 55%)'
      }}
    >
      <Box display="flex" alignItems="center" justifyContent="space-between" mb={1}>
        <Box>
          <Typography variant="h6" sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
            <InsightsIcon fontSize="small" /> Org usage analytics
          </Typography>
          <Typography variant="caption" color="text.secondary">
            Tokens &amp; completions aggregated across all conversations in this organization.
          </Typography>
        </Box>

        <ToggleButtonGroup
          size="small"
          value={days}
          exclusive
          onChange={handleChangeDays}
          aria-label="time window"
        >
          <ToggleButton value={7} aria-label="last 7 days">
            7d
          </ToggleButton>
          <ToggleButton value={30} aria-label="last 30 days">
            30d
          </ToggleButton>
          <ToggleButton value={90} aria-label="last 90 days">
            90d
          </ToggleButton>
        </ToggleButtonGroup>
      </Box>

      <Box display="flex" flexWrap="wrap" gap={2}>
        <Card
          sx={{
            flex: '1 1 220px',
            minWidth: 220,
            borderRadius: 3,
            overflow: 'hidden',
            position: 'relative',
            '&::before': {
              content: '""',
              position: 'absolute',
              inset: 0,
              background: 'linear-gradient(135deg, rgba(124,77,255,0.16), rgba(3,218,198,0.12))',
              opacity: 0.7,
              pointerEvents: 'none'
            }
          }}
        >
          <CardContent sx={{ position: 'relative' }}>
            <Typography variant="caption" color="text.secondary">
              Total tokens
            </Typography>
            <Typography variant="h5" sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
              {loading ? <CircularProgress size={20} /> : formatNumber(totalTokens)}
            </Typography>
            <Typography variant="caption" color="text.secondary">
              Sum of prompt + completion tokens
            </Typography>
          </CardContent>
        </Card>

        <Card
          sx={{
            flex: '1 1 220px',
            minWidth: 220,
            borderRadius: 3,
            overflow: 'hidden'
          }}
        >
          <CardContent>
            <Typography variant="caption" color="text.secondary">
              Prompt tokens
            </Typography>
            <Typography variant="h6">{loading ? <CircularProgress size={18} /> : formatNumber(totalPromptTokens)}</Typography>
            <Typography variant="caption" color="text.secondary">
              Input context used for org queries
            </Typography>
          </CardContent>
        </Card>

        <Card
          sx={{
            flex: '1 1 220px',
            minWidth: 220,
            borderRadius: 3,
            overflow: 'hidden'
          }}
        >
          <CardContent>
            <Typography variant="caption" color="text.secondary">
              Completion tokens
            </Typography>
            <Typography variant="h6">
              {loading ? <CircularProgress size={18} /> : formatNumber(totalCompletionTokens)}
            </Typography>
            <Typography variant="caption" color="text.secondary">
              Generated output across all chats
            </Typography>
          </CardContent>
        </Card>

        <Card
          sx={{
            flex: '1 1 220px',
            minWidth: 220,
            borderRadius: 3,
            overflow: 'hidden'
          }}
        >
          <CardContent>
            <Typography variant="caption" color="text.secondary">
              Completions
            </Typography>
            <Typography variant="h6">
              {loading ? <CircularProgress size={18} /> : completions}
            </Typography>
            <Typography variant="caption" color="text.secondary">
              Number of assistant responses with usage
            </Typography>
          </CardContent>
        </Card>
      </Box>

      <Card
        sx={{
          mt: 2,
          flex: 1,
          minHeight: 260,
          borderRadius: 3,
          display: 'flex',
          flexDirection: 'column'
        }}
      >
        <CardContent sx={{ flex: 1, display: 'flex', flexDirection: 'column', gap: 1 }}>
          <Box display="flex" alignItems="center" justifyContent="space-between" mb={1}>
            <Box display="flex" alignItems="center" gap={1}>
              <TimelineIcon fontSize="small" />
              <Typography variant="subtitle2">Daily tokens</Typography>
            </Box>
            <Box display="flex" alignItems="center" gap={1}>
              <Tooltip title="Each point represents a day within the selected window">
                <Chip
                  size="small"
                  icon={<GrainIcon sx={{ fontSize: 16 }} />}
                  label={`${days}d window`}
                  variant="outlined"
                  sx={{ height: 24, fontSize: 11 }}
                />
              </Tooltip>
            </Box>
          </Box>

          {loading && !summary ? (
            <Box flex={1} display="flex" alignItems="center" justifyContent="center">
              <CircularProgress />
            </Box>
          ) : error ? (
            <Box flex={1} display="flex" alignItems="center" justifyContent="center">
              <Typography variant="body2" color="error">
                {error}
              </Typography>
            </Box>
          ) : chartData.length === 0 ? (
            <Box flex={1} display="flex" alignItems="center" justifyContent="center">
              <Typography variant="body2" color="text.secondary">
                No usage data in this window.
              </Typography>
            </Box>
          ) : (
            <Box flex={1} sx={{ minHeight: 220 }}>
              <ResponsiveContainer width="100%" height="100%">
                <LineChart data={chartData} margin={{ top: 8, right: 16, bottom: 8, left: 0 }}>
                  <CartesianGrid strokeDasharray="3 3" opacity={0.2} />
                  <XAxis dataKey="date" tickFormatter={formatDateLabel} tick={{ fontSize: 11 }} />
                  <YAxis tick={{ fontSize: 11 }} />
                  <RechartsTooltip
                    formatter={(value: any, name: any) => [value, name]}
                    labelFormatter={(label) => `Date: ${label}`}
                  />
                  <Legend />
                  <Line type="monotone" dataKey="promptTokens" name="Prompt tokens" dot={false} strokeWidth={2} />
                  <Line type="monotone" dataKey="completionTokens" name="Completion tokens" dot={false} strokeWidth={2} />
                  <Line type="monotone" dataKey="totalTokens" name="Total tokens" dot={false} strokeWidth={2} />
                </LineChart>
              </ResponsiveContainer>
            </Box>
          )}
        </CardContent>
      </Card>
    </Box>
  );
};
```

This page provides:

- A **time‑window toggle** (7d / 30d / 90d).  
- Summary cards for total tokens, prompt tokens, completion tokens, completions.  
- A responsive **line chart** showing daily token usage with subtle gradients and micro‑interactions (tooltips, legend, hover).

---

## 16.7. Router Wiring (Example)

If your router is based on `react-router-dom`, you can mount the analytics page like this.

> **Note:** Adjust file paths according to your project layout.

### 16.7.1. Example `apps/web/src/AppRoutes.tsx`

```tsx
import React from 'react';
import { BrowserRouter, Routes, Route } from 'react-router-dom';
import { AppLayout } from './layout/AppLayout';
import { ChatShellPage } from './chat/ChatShellPage';
import { OrgAnalyticsPage } from './orgs/OrgAnalyticsPage';

export const AppRoutes: React.FC = () => {
  return (
    <BrowserRouter>
      <Routes>
        <Route path="/app" element={<AppLayout />}> 
          <Route index element={<ChatShellPage />} />
          <Route path="orgs/:orgId/analytics" element={<OrgAnalyticsPage />} />
        </Route>
      </Routes>
    </BrowserRouter>
  );
};
```

You may already have an `AppRoutes` file; in that case, just add the `OrgAnalyticsPage` route under your main authenticated layout.

---

## 16.8. Sanity Checks

From the repo root:

1. **Install dependencies (if not already):**

   ```bash
   pnpm install
   ```

2. **Run API gateway:**

   ```bash
   pnpm dev --filter=api-gateway
   ```

3. **Verify backend endpoint:**

   ```bash
   curl -H "Authorization: Bearer <token>" \
     "http://localhost:4000/orgs/<orgId>/usage?days=30"
   ```

   You should see JSON with:

   - `totals.promptTokens`, `totals.completionTokens`, `totals.totalTokens`  
   - `completions`  
   - `byDay[]` with `date` and `tokens` fields.

4. **Run web app:**

   ```bash
   cd apps/web
   pnpm dev
   ```

5. **Verify Org Analytics UI:**

   - Log in and navigate to `/app/orgs/<orgId>/analytics`.  
   - Change the time window (7 / 30 / 90); the chart should refetch and update.  
   - Hover over the line chart to see tooltips.  
   - Check that summary cards and chips match the backend data.

If all checks pass, your platform now has a **modern, Grafana‑inspired org analytics dashboard** integrated end‑to‑end.

---

## 16.9. Next Steps

Future markdown files can build on this by:

- Adding **per‑model** breakdown charts (e.g., tokens per model per day).  
- Surfacing **latency metrics** (p95 completion time) per org and per model.  
- Wiring org usage into a **billing & quota** system (limits, overage alerts, invoices).  
- Exposing CSV/JSON export for usage to plug into external BI tools.

> **AI Agent Instruction:**  
> Before moving on, ensure `org-analytics.ts` compiles, `OrgAnalyticsPage` renders correctly, and the charts display real data for an org with active conversations.

---

_End of 16.md – Org‑Level Analytics & Admin Dashboard_
