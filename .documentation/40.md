# 40. Org Admin Console, Members, API Keys & Branding – Backend + Material 3 UI

> **Audience:** AI coding assistants (Cursor, Claude Code, ChatGPT, etc.) and human backend/frontend engineers.  
> **Goal of this file:** Provide an **enterprise‑ready Admin Console** for each organization so that:
>
> - Org owners/admins can manage **members, roles and invitations**.  
> - Developers can create and manage **API keys** (per‑org and/or per‑user) for programmatic access.  
> - Orgs can customize **branding & theme** (logo, accent color, name) for white‑label experiences.  
> - Everything is multi‑tenant, RBAC‑aware, auditable (38.md) and observable (28.md).  
>
> This file is written so that Cursor‑like agents can implement it end‑to‑end without further questions.

This spec builds on:

- 11–14.md – User, Org, Role & RBAC model.  
- 19.md – Org quotas & usage guard.  
- 25.md – Core API gateway patterns.  
- 28.md – Metrics & observability.  
- 38.md – Events & audit log.  
- 39.md – Org data retention settings.

---

## 40.1. Concepts & Scope

We define three admin‑facing areas:

1. **Members & Invitations**  
   - View all org members, their roles and status.  
   - Invite users via email with a specific role.  
   - Resend / revoke invitations.  
   - Change member roles, deactivate/reactivate members.

2. **API Keys (Access Tokens)**  
   - Create **Org API keys** scoped to that organization.  
   - Each key has: name, scopes, expiration, status.  
   - Keys are only shown once upon creation, hashed in DB.  
   - Usage is rate‑limited and logged.

3. **Branding & Theme**  
   - Org display name, logo URL/upload, primary accent color.  
   - Feature flags: show org logo on chat screen, custom favicon, etc.

All features must obey **RBAC** (e.g. only `org:admin` or specific permissions) and emit **events** for audit log.

---

## 40.2. Data Model – Prisma Extensions

Extend `packages/db/prisma/schema.prisma` with models for invitations, API keys and branding.

```prisma
model OrgInvitation {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  orgId       String
  email       String

  // role slug or id, depending on RBAC model
  role        String

  // who invited this person
  invitedBy   String

  // token for accepting invitation
  token       String   @unique

  // "pending" | "accepted" | "revoked" | "expired"
  status      String

  expiresAt   DateTime?

  org     Org   @relation(fields: [orgId], references: [id])
  inviter User  @relation(fields: [invitedBy], references: [id])
}

model OrgApiKey {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  orgId       String
  createdById String

  // Human-readable name
  name        String

  // Hashed token (e.g. HMAC SHA-256 of raw key)
  hash        String   @unique

  // Optional description or use-case
  description String?

  // Array of scope strings, e.g. ["chat:invoke", "org:metrics:read"]
  scopes      Json

  // Optional ISO date for expiry
  expiresAt   DateTime?

  // Whether the key can still be used
  isActive    Boolean  @default(true)

  org     Org  @relation(fields: [orgId], references: [id])
  creator User @relation(fields: [createdById], references: [id])
}

model OrgBrandingConfig {
  id          String   @id @default(cuid())
  orgId       String   @unique

  displayName String?
  logoUrl     String?

  // Hex color string, e.g. "#0F766E"
  primaryColor String?

  showLogoOnChat Boolean @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  org Org @relation(fields: [orgId], references: [id])
}
```

Run migrations after editing the schema.

---

## 40.3. Members & Invitations – Backend

### 40.3.1. DTOs & Utilities

**File:** `apps/api-gateway/src/admin/types.ts`

```ts
// apps/api-gateway/src/admin/types.ts

export interface OrgMemberDto {
  id: string;
  email: string;
  displayName: string | null;
  role: string;
  status: 'active' | 'disabled';
  joinedAt: string;
}

export interface OrgInvitationDto {
  id: string;
  email: string;
  role: string;
  status: 'pending' | 'accepted' | 'revoked' | 'expired';
  createdAt: string;
  expiresAt: string | null;
}
```

We assume an existing **membership table** (e.g. `OrgMember` or `OrgUser`) with a role field; Cursor can connect this DTO to that model when implementing.

### 40.3.2. Routes – List Members & Invitations

**File:** `apps/api-gateway/src/routes/orgAdminMembers.ts`

```ts
// apps/api-gateway/src/routes/orgAdminMembers.ts

import { FastifyInstance, FastifyPluginOptions } from 'fastify';
import { z } from 'zod';
import { prisma } from '@ai-chat/db';
import { JwtPayload } from '../auth/types';
import { assertOrgPermission } from '../rbac/guards';

export default async function orgAdminMembersRoutes(
  app: FastifyInstance,
  _opts: FastifyPluginOptions
) {
  app.get('/orgs/:orgId/admin/members', { preHandler: [app.authenticate] }, async (request, reply) => {
    const payload = request.user as JwtPayload;
    const orgId = (request.params as any).orgId as string;

    await assertOrgPermission(
      { id: payload.userId, isSuperadmin: payload.isSuperadmin },
      orgId,
      'org:admin:members:read'
    );

    const members = await prisma.orgMember.findMany({
      where: { orgId },
      include: {
        user: {
          select: {
            id: true,
            email: true,
            displayName: true,
            createdAt: true
          }
        }
      }
    });

    const invitations = await prisma.orgInvitation.findMany({
      where: { orgId },
      orderBy: { createdAt: 'desc' }
    });

    return reply.send({
      members: members.map((m) => ({
        id: m.user.id,
        email: m.user.email,
        displayName: m.user.displayName,
        role: m.role,
        status: m.isDisabled ? 'disabled' : 'active',
        joinedAt: m.user.createdAt.toISOString()
      })),
      invitations: invitations.map((inv) => ({
        id: inv.id,
        email: inv.email,
        role: inv.role,
        status: inv.status as any,
        createdAt: inv.createdAt.toISOString(),
        expiresAt: inv.expiresAt ? inv.expiresAt.toISOString() : null
      }))
    });
  });
}
```

Register in `main.ts`:

```ts
import orgAdminMembersRoutes from './routes/orgAdminMembers';

await app.register(orgAdminMembersRoutes);
```

### 40.3.3. Routes – Invite User & Manage Member Roles

Extend `orgAdminMembersRoutes` with POST/PATCH endpoints.

```ts
const inviteBodySchema = z.object({
  email: z.string().email(),
  role: z.string().min(1),
  expiresInDays: z.number().int().min(1).max(60).default(7)
});

const updateMemberRoleSchema = z.object({
  role: z.string().min(1)
});

const toggleMemberStatusSchema = z.object({
  disabled: z.boolean() 
});

export default async function orgAdminMembersRoutes(
  app: FastifyInstance,
  _opts: FastifyPluginOptions
) {
  // ... GET route above

  // Invite
  app.post('/orgs/:orgId/admin/members/invite', { preHandler: [app.authenticate] }, async (request, reply) => {
    const payload = request.user as JwtPayload;
    const orgId = (request.params as any).orgId as string;

    await assertOrgPermission(
      { id: payload.userId, isSuperadmin: payload.isSuperadmin },
      orgId,
      'org:admin:members:write'
    );

    const parsed = inviteBodySchema.safeParse(request.body);
    if (!parsed.success) {
      return reply.code(400).send({ error: 'INVALID_BODY', details: parsed.error.format() });
    }

    const { email, role, expiresInDays } = parsed.data;

    const token = crypto.randomBytes(24).toString('hex');
    const expiresAt = new Date(Date.now() + expiresInDays * 24 * 60 * 60 * 1000);

    const inv = await prisma.orgInvitation.create({
      data: {
        orgId,
        email,
        role,
        invitedBy: payload.userId,
        token,
        status: 'pending',
        expiresAt
      }
    });

    // TODO: send email (out of scope for this spec)

    // Optional: emitEvent('org.member_invited', ...)

    return reply.code(201).send({ id: inv.id });
  });

  // Update role
  app.patch('/orgs/:orgId/admin/members/:userId/role', { preHandler: [app.authenticate] }, async (request, reply) => {
    const payload = request.user as JwtPayload;
    const { orgId, userId } = request.params as any;

    await assertOrgPermission(
      { id: payload.userId, isSuperadmin: payload.isSuperadmin },
      orgId,
      'org:admin:members:write'
    );

    const parsed = updateMemberRoleSchema.safeParse(request.body);
    if (!parsed.success) {
      return reply.code(400).send({ error: 'INVALID_BODY', details: parsed.error.format() });
    }

    await prisma.orgMember.updateMany({
      where: { orgId, userId },
      data: { role: parsed.data.role }
    });

    return reply.send({ ok: true });
  });

  // Enable / disable member
  app.patch('/orgs/:orgId/admin/members/:userId/status', { preHandler: [app.authenticate] }, async (request, reply) => {
    const payload = request.user as JwtPayload;
    const { orgId, userId } = request.params as any;

    await assertOrgPermission(
      { id: payload.userId, isSuperadmin: payload.isSuperadmin },
      orgId,
      'org:admin:members:write'
    );

    const parsed = toggleMemberStatusSchema.safeParse(request.body);
    if (!parsed.success) {
      return reply.code(400).send({ error: 'INVALID_BODY', details: parsed.error.format() });
    }

    await prisma.orgMember.updateMany({
      where: { orgId, userId },
      data: { isDisabled: parsed.data.disabled }
    });

    return reply.send({ ok: true });
  });
}
```

> The **invitation acceptance flow** (token → sign‑up / org join) can reuse existing auth patterns and is not detailed here.

---

## 40.4. Org API Keys – Backend

### 40.4.1. Utility – Token Generation & Hashing

**File:** `apps/api-gateway/src/apiKeys/utils.ts`

```ts
// apps/api-gateway/src/apiKeys/utils.ts

import crypto from 'node:crypto';

export interface GeneratedApiKey {
  raw: string;
  hash: string;
}

export function generateOrgApiKey(orgId: string): GeneratedApiKey {
  const raw = `org_${orgId}_${crypto.randomBytes(24).toString('hex')}`;
  const hash = crypto.createHash('sha256').update(raw).digest('hex');
  return { raw, hash };
}

export function hashExistingToken(raw: string): string {
  return crypto.createHash('sha256').update(raw).digest('hex');
}
```

### 40.4.2. API Routes – CRUD

**File:** `apps/api-gateway/src/routes/orgApiKeys.ts`

```ts
// apps/api-gateway/src/routes/orgApiKeys.ts

import { FastifyInstance, FastifyPluginOptions } from 'fastify';
import { z } from 'zod';
import { prisma } from '@ai-chat/db';
import { JwtPayload } from '../auth/types';
import { assertOrgPermission } from '../rbac/guards';
import { generateOrgApiKey } from '../apiKeys/utils';

const createKeySchema = z.object({
  name: z.string().min(1).max(128),
  description: z.string().max(512).optional(),
  scopes: z.array(z.string()).min(1),
  expiresAt: z.string().datetime().optional()
});

const updateKeySchema = z.object({
  name: z.string().min(1).max(128).optional(),
  description: z.string().max(512).optional(),
  scopes: z.array(z.string()).min(1).optional(),
  expiresAt: z.string().datetime().optional(),
  isActive: z.boolean().optional()
});

export default async function orgApiKeysRoutes(app: FastifyInstance, _opts: FastifyPluginOptions) {
  // List keys (no secret)
  app.get('/orgs/:orgId/admin/api-keys', { preHandler: [app.authenticate] }, async (request, reply) => {
    const payload = request.user as JwtPayload;
    const orgId = (request.params as any).orgId as string;

    await assertOrgPermission(
      { id: payload.userId, isSuperadmin: payload.isSuperadmin },
      orgId,
      'org:admin:api-keys:read'
    );

    const keys = await prisma.orgApiKey.findMany({
      where: { orgId },
      orderBy: { createdAt: 'desc' }
    });

    return reply.send({
      keys: keys.map((k) => ({
        id: k.id,
        name: k.name,
        description: k.description,
        scopes: k.scopes,
        isActive: k.isActive,
        createdAt: k.createdAt.toISOString(),
        expiresAt: k.expiresAt ? k.expiresAt.toISOString() : null
      }))
    });
  });

  // Create key (returns raw token once)
  app.post('/orgs/:orgId/admin/api-keys', { preHandler: [app.authenticate] }, async (request, reply) => {
    const payload = request.user as JwtPayload;
    const orgId = (request.params as any).orgId as string;

    await assertOrgPermission(
      { id: payload.userId, isSuperadmin: payload.isSuperadmin },
      orgId,
      'org:admin:api-keys:write'
    );

    const parsed = createKeySchema.safeParse(request.body);
    if (!parsed.success) {
      return reply.code(400).send({ error: 'INVALID_BODY', details: parsed.error.format() });
    }

    const { raw, hash } = generateOrgApiKey(orgId);

    const key = await prisma.orgApiKey.create({
      data: {
        orgId,
        createdById: payload.userId,
        name: parsed.data.name,
        description: parsed.data.description ?? null,
        scopes: parsed.data.scopes,
        expiresAt: parsed.data.expiresAt ? new Date(parsed.data.expiresAt) : null,
        hash,
        isActive: true
      }
    });

    // Optional: emitEvent('org.api_key_created', ...)

    return reply.code(201).send({
      id: key.id,
      token: raw // show only once
    });
  });

  // Update key metadata / status
  app.patch('/orgs/:orgId/admin/api-keys/:keyId', { preHandler: [app.authenticate] }, async (request, reply) => {
    const payload = request.user as JwtPayload;
    const { orgId, keyId } = request.params as any;

    await assertOrgPermission(
      { id: payload.userId, isSuperadmin: payload.isSuperadmin },
      orgId,
      'org:admin:api-keys:write'
    );

    const parsed = updateKeySchema.safeParse(request.body);
    if (!parsed.success) {
      return reply.code(400).send({ error: 'INVALID_BODY', details: parsed.error.format() });
    }

    await prisma.orgApiKey.updateMany({
      where: { id: keyId, orgId },
      data: {
        name: parsed.data.name,
        description: parsed.data.description,
        scopes: parsed.data.scopes,
        expiresAt: parsed.data.expiresAt ? new Date(parsed.data.expiresAt) : undefined,
        isActive: parsed.data.isActive
      }
    });

    return reply.send({ ok: true });
  });

  // Delete key
  app.delete('/orgs/:orgId/admin/api-keys/:keyId', { preHandler: [app.authenticate] }, async (request, reply) => {
    const payload = request.user as JwtPayload;
    const { orgId, keyId } = request.params as any;

    await assertOrgPermission(
      { id: payload.userId, isSuperadmin: payload.isSuperadmin },
      orgId,
      'org:admin:api-keys:write'
    );

    await prisma.orgApiKey.deleteMany({ where: { id: keyId, orgId } });

    return reply.send({ ok: true });
  });
}
```

Register route in `main.ts`:

```ts
import orgApiKeysRoutes from './routes/orgApiKeys';

await app.register(orgApiKeysRoutes);
```

### 40.4.3. API Key Authentication (High‑Level)

The platform can support API keys by:

1. Allowing clients to add `Authorization: Bearer <api-key>` headers.  
2. In an auth hook, detect this pattern and:  
   - Hash the provided token.  
   - Look up `OrgApiKey` by `hash` where `isActive = true` and `expiresAt` not in the past.  
   - Load org + creator user + scopes, build a **synthetic JwtPayload** with limited permissions.  
3. Enforce scopes per route (e.g. `chat:invoke`, `org:metrics:read`).

Implementation details can be added in the dedicated auth file and are outside this doc’s line‑by‑line scope.

---

## 40.5. Org Branding – Backend

### 40.5.1. Routes

**File:** `apps/api-gateway/src/routes/orgBranding.ts`

```ts
// apps/api-gateway/src/routes/orgBranding.ts

import { FastifyInstance, FastifyPluginOptions } from 'fastify';
import { z } from 'zod';
import { prisma } from '@ai-chat/db';
import { JwtPayload } from '../auth/types';
import { assertOrgPermission } from '../rbac/guards';

const brandingSchema = z.object({
  displayName: z.string().max(128).nullable().optional(),
  logoUrl: z.string().url().max(1024).nullable().optional(),
  primaryColor: z.string().regex(/^#([0-9a-fA-F]{6})$/).nullable().optional(),
  showLogoOnChat: z.boolean().optional()
});

export default async function orgBrandingRoutes(app: FastifyInstance, _opts: FastifyPluginOptions) {
  app.get('/orgs/:orgId/branding', { preHandler: [app.authenticate] }, async (request, reply) => {
    const payload = request.user as JwtPayload;
    const orgId = (request.params as any).orgId as string;

    await assertOrgPermission(
      { id: payload.userId, isSuperadmin: payload.isSuperadmin },
      orgId,
      'org:settings:read'
    );

    const cfg = await prisma.orgBrandingConfig.findUnique({ where: { orgId } });
    return reply.send({ config: cfg });
  });

  app.put('/orgs/:orgId/branding', { preHandler: [app.authenticate] }, async (request, reply) => {
    const payload = request.user as JwtPayload;
    const orgId = (request.params as any).orgId as string;

    await assertOrgPermission(
      { id: payload.userId, isSuperadmin: payload.isSuperadmin },
      orgId,
      'org:settings:write'
    );

    const parsed = brandingSchema.safeParse(request.body);
    if (!parsed.success) {
      return reply.code(400).send({ error: 'INVALID_BODY', details: parsed.error.format() });
    }

    const cfg = await prisma.orgBrandingConfig.upsert({
      where: { orgId },
      update: {
        displayName: parsed.data.displayName ?? undefined,
        logoUrl: parsed.data.logoUrl ?? undefined,
        primaryColor: parsed.data.primaryColor ?? undefined,
        showLogoOnChat:
          typeof parsed.data.showLogoOnChat === 'boolean'
            ? parsed.data.showLogoOnChat
            : undefined
      },
      create: {
        orgId,
        displayName: parsed.data.displayName ?? null,
        logoUrl: parsed.data.logoUrl ?? null,
        primaryColor: parsed.data.primaryColor ?? null,
        showLogoOnChat: parsed.data.showLogoOnChat ?? true
      }
    });

    return reply.send({ config: cfg });
  });
}
```

Register:

```ts
import orgBrandingRoutes from './routes/orgBranding';

await app.register(orgBrandingRoutes);
```

---

## 40.6. Frontend – Admin API Wrappers

### 40.6.1. Members & Invitations

**File:** `apps/web/src/api/orgAdminMembers.ts`

```ts
// apps/web/src/api/orgAdminMembers.ts

import { apiRequest } from './client';

export interface OrgMemberDto {
  id: string;
  email: string;
  displayName: string | null;
  role: string;
  status: 'active' | 'disabled';
  joinedAt: string;
}

export interface OrgInvitationDto {
  id: string;
  email: string;
  role: string;
  status: 'pending' | 'accepted' | 'revoked' | 'expired';
  createdAt: string;
  expiresAt: string | null;
}

export interface OrgMembersResponse {
  members: OrgMemberDto[];
  invitations: OrgInvitationDto[];
}

export async function fetchOrgMembers(token: string, orgId: string): Promise<OrgMembersResponse> {
  return apiRequest<OrgMembersResponse>(
    `/orgs/${orgId}/admin/members`,
    { method: 'GET' },
    token
  );
}

export async function inviteOrgMember(
  token: string,
  orgId: string,
  email: string,
  role: string,
  expiresInDays = 7
): Promise<{ id: string }> {
  return apiRequest<{ id: string }>(
    `/orgs/${orgId}/admin/members/invite`,
    {
      method: 'POST',
      body: JSON.stringify({ email, role, expiresInDays })
    },
    token
  );
}

export async function updateMemberRole(
  token: string,
  orgId: string,
  userId: string,
  role: string
): Promise<void> {
  await apiRequest<{ ok: boolean }>(
    `/orgs/${orgId}/admin/members/${userId}/role`,
    {
      method: 'PATCH',
      body: JSON.stringify({ role })
    },
    token
  );
}

export async function updateMemberStatus(
  token: string,
  orgId: string,
  userId: string,
  disabled: boolean
): Promise<void> {
  await apiRequest<{ ok: boolean }>(
    `/orgs/${orgId}/admin/members/${userId}/status`,
    {
      method: 'PATCH',
      body: JSON.stringify({ disabled })
    },
    token
  );
}
```

### 40.6.2. API Keys

**File:** `apps/web/src/api/orgApiKeys.ts`

```ts
// apps/web/src/api/orgApiKeys.ts

import { apiRequest } from './client';

export interface OrgApiKeySummary {
  id: string;
  name: string;
  description?: string | null;
  scopes: string[];
  isActive: boolean;
  createdAt: string;
  expiresAt: string | null;
}

export async function fetchOrgApiKeys(
  token: string,
  orgId: string
): Promise<{ keys: OrgApiKeySummary[] }> {
  return apiRequest<{ keys: OrgApiKeySummary[] }>(
    `/orgs/${orgId}/admin/api-keys`,
    { method: 'GET' },
    token
  );
}

export async function createOrgApiKey(
  token: string,
  orgId: string,
  input: { name: string; description?: string; scopes: string[]; expiresAt?: string }
): Promise<{ id: string; token: string }> {
  return apiRequest<{ id: string; token: string }>(
    `/orgs/${orgId}/admin/api-keys`,
    {
      method: 'POST',
      body: JSON.stringify(input)
    },
    token
  );
}

export async function updateOrgApiKey(
  token: string,
  orgId: string,
  keyId: string,
  data: Partial<{
    name: string;
    description: string;
    scopes: string[];
    expiresAt: string;
    isActive: boolean;
  }>
): Promise<void> {
  await apiRequest<{ ok: boolean }>(
    `/orgs/${orgId}/admin/api-keys/${keyId}`,
    {
      method: 'PATCH',
      body: JSON.stringify(data)
    },
    token
  );
}

export async function deleteOrgApiKey(
  token: string,
  orgId: string,
  keyId: string
): Promise<void> {
  await apiRequest<{ ok: boolean }>(
    `/orgs/${orgId}/admin/api-keys/${keyId}`,
    { method: 'DELETE' },
    token
  );
}
```

### 40.6.3. Branding

**File:** `apps/web/src/api/orgBranding.ts`

```ts
// apps/web/src/api/orgBranding.ts

import { apiRequest } from './client';

export interface OrgBrandingConfigDto {
  id: string;
  orgId: string;
  displayName: string | null;
  logoUrl: string | null;
  primaryColor: string | null;
  showLogoOnChat: boolean;
}

export async function fetchOrgBranding(
  token: string,
  orgId: string
): Promise<{ config: OrgBrandingConfigDto | null }> {
  return apiRequest<{ config: OrgBrandingConfigDto | null }>(
    `/orgs/${orgId}/branding`,
    { method: 'GET' },
    token
  );
}

export async function updateOrgBranding(
  token: string,
  orgId: string,
  data: Partial<{
    displayName: string | null;
    logoUrl: string | null;
    primaryColor: string | null;
    showLogoOnChat: boolean;
  }>
): Promise<{ config: OrgBrandingConfigDto }> {
  return apiRequest<{ config: OrgBrandingConfigDto }>(
    `/orgs/${orgId}/branding`,
    {
      method: 'PUT',
      body: JSON.stringify(data)
    },
    token
  );
}
```

---

## 40.7. Material 3 UI – Org Admin Console Pages

We add three Admin pages under org settings:

- `/app/orgs/:orgId/settings/members`  
- `/app/orgs/:orgId/settings/api-keys`  
- `/app/orgs/:orgId/settings/branding`

### 40.7.1. Members Page

**File:** `apps/web/src/org/OrgMembersPage.tsx`

```tsx
// apps/web/src/org/OrgMembersPage.tsx

import React, { useEffect, useState } from 'react';
import {
  Box,
  Button,
  Card,
  CardContent,
  Dialog,
  DialogActions,
  DialogContent,
  DialogTitle,
  IconButton,
  MenuItem,
  Select,
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableRow,
  TextField,
  Typography
} from '@mui/material';
import AutoAwesomeIcon from '@mui/icons-material/AutoAwesome';
import BlockIcon from '@mui/icons-material/Block';
import CheckCircleIcon from '@mui/icons-material/CheckCircle';
import PersonAddIcon from '@mui/icons-material/PersonAdd';
import { useParams } from 'react-router-dom';
import { useAuth } from '../auth/AuthContext';
import {
  OrgMemberDto,
  OrgInvitationDto,
  fetchOrgMembers,
  inviteOrgMember,
  updateMemberRole,
  updateMemberStatus
} from '../api/orgAdminMembers';

export const OrgMembersPage: React.FC = () => {
  const { orgId } = useParams();
  const { token } = useAuth();

  const [members, setMembers] = useState<OrgMemberDto[]>([]);
  const [invitations, setInvitations] = useState<OrgInvitationDto[]>([]);
  const [loading, setLoading] = useState(false);
  const [dialogOpen, setDialogOpen] = useState(false);
  const [inviteEmail, setInviteEmail] = useState('');
  const [inviteRole, setInviteRole] = useState('org:member');

  const gradientBg =
    'radial-gradient(circle at top left, rgba(129,140,248,0.16), transparent 55%), ' +
    'radial-gradient(circle at bottom right, rgba(56,189,248,0.18), transparent 55%)';

  const load = async () => {
    if (!token || !orgId) return;
    setLoading(true);
    try {
      const res = await fetchOrgMembers(token, orgId);
      setMembers(res.members);
      setInvitations(res.invitations);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    void load();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [orgId, token]);

  const handleInvite = async () => {
    if (!token || !orgId) return;
    await inviteOrgMember(token, orgId, inviteEmail, inviteRole, 7);
    setInviteEmail('');
    setInviteRole('org:member');
    setDialogOpen(false);
    void load();
  };

  const handleRoleChange = async (userId: string, role: string) => {
    if (!token || !orgId) return;
    await updateMemberRole(token, orgId, userId, role);
    void load();
  };

  const handleToggleStatus = async (member: OrgMemberDto) => {
    if (!token || !orgId) return;
    await updateMemberStatus(token, orgId, member.id, member.status === 'active');
    void load();
  };

  return (
    <Box
      sx={{
        p: 2,
        display: 'flex',
        flexDirection: 'column',
        gap: 2,
        height: '100%',
        backgroundImage: gradientBg,
        backgroundColor: 'background.default'
      }}
    >
      <Box display="flex" alignItems="center" justifyContent="space-between">
        <Box display="flex" alignItems="center" gap={1}>
          <AutoAwesomeIcon fontSize="small" />
          <Box>
            <Typography variant="h6">Members</Typography>
            <Typography variant="caption" color="text.secondary">
              Manage who can access this organization and what they can do.
            </Typography>
          </Box>
        </Box>
        <Button
          variant="contained"
          size="small"
          startIcon={<PersonAddIcon />}
          onClick={() => setDialogOpen(true)}
        >
          Invite member
        </Button>
      </Box>

      <Card sx={{ borderRadius: 3 }}>
        <CardContent>
          <Typography variant="subtitle2" gutterBottom>
            Members
          </Typography>
          <Table size="small">
            <TableHead>
              <TableRow>
                <TableCell>Email</TableCell>
                <TableCell>Name</TableCell>
                <TableCell>Role</TableCell>
                <TableCell>Status</TableCell>
                <TableCell align="right">Actions</TableCell>
              </TableRow>
            </TableHead>
            <TableBody>
              {members.map((m) => (
                <TableRow key={m.id} hover>
                  <TableCell>{m.email}</TableCell>
                  <TableCell>{m.displayName}</TableCell>
                  <TableCell>
                    <Select
                      size="small"
                      value={m.role}
                      onChange={(e) => handleRoleChange(m.id, e.target.value as string)}
                    >
                      <MenuItem value="org:member">Member</MenuItem>
                      <MenuItem value="org:admin">Admin</MenuItem>
                    </Select>
                  </TableCell>
                  <TableCell>
                    {m.status === 'active' ? (
                      <Box display="flex" alignItems="center" gap={0.5}>
                        <CheckCircleIcon fontSize="small" color="success" />
                        <Typography variant="caption">Active</Typography>
                      </Box>
                    ) : (
                      <Box display="flex" alignItems="center" gap={0.5}>
                        <BlockIcon fontSize="small" color="disabled" />
                        <Typography variant="caption">Disabled</Typography>
                      </Box>
                    )}
                  </TableCell>
                  <TableCell align="right">
                    <IconButton
                      size="small"
                      onClick={() => handleToggleStatus(m)}
                    >
                      {m.status === 'active' ? (
                        <BlockIcon fontSize="small" />
                      ) : (
                        <CheckCircleIcon fontSize="small" />
                      )}
                    </IconButton>
                  </TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        </CardContent>
      </Card>

      <Card sx={{ borderRadius: 3 }}>
        <CardContent>
          <Typography variant="subtitle2" gutterBottom>
            Pending invitations
          </Typography>
          {invitations.length === 0 && (
            <Typography variant="body2" color="text.secondary">
              No pending invitations.
            </Typography>
          )}
          {invitations.length > 0 && (
            <Table size="small">
              <TableHead>
                <TableRow>
                  <TableCell>Email</TableCell>
                  <TableCell>Role</TableCell>
                  <TableCell>Status</TableCell>
                  <TableCell>Expires</TableCell>
                </TableRow>
              </TableHead>
              <TableBody>
                {invitations.map((inv) => (
                  <TableRow key={inv.id}>
                    <TableCell>{inv.email}</TableCell>
                    <TableCell>{inv.role}</TableCell>
                    <TableCell>{inv.status}</TableCell>
                    <TableCell>
                      {inv.expiresAt ?
                        new Date(inv.expiresAt).toLocaleDateString() :
                        '—'}
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          )}
        </CardContent>
      </Card>

      <Dialog open={dialogOpen} onClose={() => setDialogOpen(false)} maxWidth="xs" fullWidth>
        <DialogTitle>Invite member</DialogTitle>
        <DialogContent sx={{ display: 'flex', flexDirection: 'column', gap: 2, mt: 1 }}>
          <TextField
            label="Email"
            type="email"
            fullWidth
            value={inviteEmail}
            onChange={(e) => setInviteEmail(e.target.value)}
          />
          <Select
            size="small"
            value={inviteRole}
            onChange={(e) => setInviteRole(e.target.value as string)}
          >
            <MenuItem value="org:member">Member</MenuItem>
            <MenuItem value="org:admin">Admin</MenuItem>
          </Select>
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setDialogOpen(false)}>Cancel</Button>
          <Button
            onClick={handleInvite}
            disabled={!inviteEmail}
          >
            Send invite
          </Button>
        </DialogActions>
      </Dialog>
    </Box>
  );
};
```

### 40.7.2. API Keys Page

**File:** `apps/web/src/org/OrgApiKeysPage.tsx`

```tsx
// apps/web/src/org/OrgApiKeysPage.tsx

import React, { useEffect, useState } from 'react';
import {
  Box,
  Button,
  Card,
  CardContent,
  Dialog,
  DialogActions,
  DialogContent,
  DialogTitle,
  IconButton,
  MenuItem,
  Select,
  TextField,
  Tooltip,
  Typography
} from '@mui/material';
import AutoAwesomeIcon from '@mui/icons-material/AutoAwesome';
import DeleteIcon from '@mui/icons-material/Delete';
import ContentCopyIcon from '@mui/icons-material/ContentCopy';
import KeyIcon from '@mui/icons-material/VpnKey';
import { useParams } from 'react-router-dom';
import { useAuth } from '../auth/AuthContext';
import {
  OrgApiKeySummary,
  fetchOrgApiKeys,
  createOrgApiKey,
  deleteOrgApiKey
} from '../api/orgApiKeys';

export const OrgApiKeysPage: React.FC = () => {
  const { orgId } = useParams();
  const { token } = useAuth();

  const [keys, setKeys] = useState<OrgApiKeySummary[]>([]);
  const [loading, setLoading] = useState(false);
  const [dialogOpen, setDialogOpen] = useState(false);

  const [name, setName] = useState('');
  const [description, setDescription] = useState('');
  const [scopesText, setScopesText] = useState('chat:invoke');
  const [expiresInDays, setExpiresInDays] = useState('30');
  const [newToken, setNewToken] = useState<string | null>(null);

  const gradientBg =
    'radial-gradient(circle at top left, rgba(236,72,153,0.15), transparent 55%), ' +
    'radial-gradient(circle at bottom right, rgba(56,189,248,0.16), transparent 55%)';

  const load = async () => {
    if (!token || !orgId) return;
    setLoading(true);
    try {
      const res = await fetchOrgApiKeys(token, orgId);
      setKeys(res.keys);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    void load();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [orgId, token]);

  const handleCreate = async () => {
    if (!token || !orgId) return;

    const scopes = scopesText
      .split(',')
      .map((s) => s.trim())
      .filter(Boolean);

    const expiresAt = expiresInDays
      ? new Date(Date.now() + Number(expiresInDays) * 24 * 60 * 60 * 1000).toISOString()
      : undefined;

    const res = await createOrgApiKey(token, orgId, {
      name: name.trim(),
      description: description.trim() || undefined,
      scopes,
      expiresAt
    });

    setNewToken(res.token);
    setName('');
    setDescription('');
    setScopesText('chat:invoke');
    setExpiresInDays('30');
    void load();
  };

  const handleDelete = async (id: string) => {
    if (!token || !orgId) return;
    await deleteOrgApiKey(token, orgId, id);
    void load();
  };

  const handleCopy = async () => {
    if (!newToken) return;
    try {
      await navigator.clipboard.writeText(newToken);
    } catch {
      // ignore
    }
  };

  return (
    <Box
      sx={{
        p: 2,
        display: 'flex',
        flexDirection: 'column',
        gap: 2,
        height: '100%',
        backgroundImage: gradientBg,
        backgroundColor: 'background.default'
      }}
    >
      <Box display="flex" alignItems="center" justifyContent="space-between">
        <Box display="flex" alignItems="center" gap={1}>
          <AutoAwesomeIcon fontSize="small" />
          <Box>
            <Typography variant="h6">API keys</Typography>
            <Typography variant="caption" color="text.secondary">
              Create keys for programmatic access to this organization.
            </Typography>
          </Box>
        </Box>
        <Button
          variant="contained"
          size="small"
          startIcon={<KeyIcon />}
          onClick={() => {
            setNewToken(null);
            setDialogOpen(true);
          }}
        >
          New API key
        </Button>
      </Box>

      <Card sx={{ borderRadius: 3 }}>
        <CardContent sx={{ display: 'flex', flexDirection: 'column', gap: 1 }}>
          {keys.length === 0 && (
            <Typography variant="body2" color="text.secondary">
              No API keys yet.
            </Typography>
          )}

          {keys.map((k) => (
            <Box
              key={k.id}
              sx={{
                p: 1.25,
                borderRadius: 2,
                border: '1px solid',
                borderColor: 'divider',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'space-between',
                gap: 2
              }}
            >
              <Box>
                <Typography variant="body2">{k.name}</Typography>
                <Typography variant="caption" color="text.secondary">
                  {k.description || 'No description'}
                </Typography>
                <Box mt={0.5} display="flex" flexWrap="wrap" gap={0.5}>
                  {k.scopes.map((s) => (
                    <Box
                      key={s}
                      sx={{
                        px: 0.75,
                        py: 0.25,
                        borderRadius: 999,
                        border: '1px solid',
                        borderColor: 'divider'
                      }}
                    >
                      <Typography variant="caption">{s}</Typography>
                    </Box>
                  ))}
                </Box>
              </Box>
              <Box display="flex" flexDirection="column" alignItems="flex-end" gap={0.5}>
                <Typography variant="caption" color="text.secondary">
                  Created {new Date(k.createdAt).toLocaleDateString()}
                </Typography>
                {k.expiresAt && (
                  <Typography variant="caption" color="text.secondary">
                    Expires {new Date(k.expiresAt).toLocaleDateString()}
                  </Typography>
                )}
                <Tooltip title="Delete key">
                  <IconButton size="small" onClick={() => handleDelete(k.id)}>
                    <DeleteIcon fontSize="small" />
                  </IconButton>
                </Tooltip>
              </Box>
            </Box>
          ))}
        </CardContent>
      </Card>

      <Dialog open={dialogOpen} onClose={() => setDialogOpen(false)} maxWidth="sm" fullWidth>
        <DialogTitle>New API key</DialogTitle>
        <DialogContent sx={{ display: 'flex', flexDirection: 'column', gap: 2, mt: 1 }}>
          <TextField
            label="Name"
            fullWidth
            value={name}
            onChange={(e) => setName(e.target.value)}
          />
          <TextField
            label="Description"
            fullWidth
            value={description}
            onChange={(e) => setDescription(e.target.value)}
          />
          <TextField
            label="Scopes (comma separated)"
            fullWidth
            value={scopesText}
            onChange={(e) => setScopesText(e.target.value)}
            helperText="Example: chat:invoke, org:metrics:read"
          />
          <TextField
            label="Expires in (days)"
            fullWidth
            value={expiresInDays}
            onChange={(e) => setExpiresInDays(e.target.value)}
          />

          {newToken && (
            <Box mt={1}>
              <Typography variant="caption" color="text.secondary">
                This token will only be shown once. Copy and store it securely.
              </Typography>
              <Box
                sx={{
                  mt: 0.5,
                  p: 1,
                  borderRadius: 2,
                  border: '1px solid',
                  borderColor: 'divider',
                  display: 'flex',
                  alignItems: 'center',
                  gap: 1
                }}
              >
                <Typography
                  variant="caption"
                  sx={{ wordBreak: 'break-all' }}
                >
                  {newToken}
                </Typography>
                <Button
                  size="small"
                  variant="text"
                  startIcon={<ContentCopyIcon fontSize="small" />}
                  onClick={handleCopy}
                >
                  Copy
                </Button>
              </Box>
            </Box>
          )}
        </DialogContent>
        <DialogActions>
          {!newToken && (
            <Button
              onClick={handleCreate}
              disabled={!name.trim()}
            >
              Create
            </Button>
          )}
          <Button onClick={() => setDialogOpen(false)}>Close</Button>
        </DialogActions>
      </Dialog>
    </Box>
  );
};
```

### 40.7.3. Branding Page

**File:** `apps/web/src/org/OrgBrandingPage.tsx`

```tsx
// apps/web/src/org/OrgBrandingPage.tsx

import React, { useEffect, useState } from 'react';
import {
  Box,
  Button,
  Card,
  CardContent,
  FormControlLabel,
  Switch,
  TextField,
  Typography
} from '@mui/material';
import AutoAwesomeIcon from '@mui/icons-material/AutoAwesome';
import { useParams } from 'react-router-dom';
import { useAuth } from '../auth/AuthContext';
import { fetchOrgBranding, updateOrgBranding, OrgBrandingConfigDto } from '../api/orgBranding';

export const OrgBrandingPage: React.FC = () => {
  const { orgId } = useParams();
  const { token } = useAuth();

  const [config, setConfig] = useState<OrgBrandingConfigDto | null>(null);
  const [loading, setLoading] = useState(false);

  const gradientBg =
    'radial-gradient(circle at top left, rgba(45,212,191,0.18), transparent 55%), ' +
    'radial-gradient(circle at bottom right, rgba(129,140,248,0.22), transparent 55%)';

  useEffect(() => {
    if (!token || !orgId) return;

    let cancelled = false;

    async function load() {
      setLoading(true);
      try {
        const res = await fetchOrgBranding(token, orgId);
        if (!cancelled) {
          setConfig(
            res.config || {
              id: 'temp',
              orgId,
              displayName: '',
              logoUrl: '',
              primaryColor: '#2563EB',
              showLogoOnChat: true
            }
          );
        }
      } finally {
        if (!cancelled) setLoading(false);
      }
    }

    void load();

    return () => {
      cancelled = true;
    };
  }, [token, orgId]);

  const handleSave = async () => {
    if (!token || !orgId || !config) return;

    const res = await updateOrgBranding(token, orgId, {
      displayName: config.displayName,
      logoUrl: config.logoUrl,
      primaryColor: config.primaryColor,
      showLogoOnChat: config.showLogoOnChat
    });

    setConfig(res.config);
  };

  if (!config) {
    return null;
  }

  return (
    <Box
      sx={{
        p: 2,
        display: 'flex',
        flexDirection: 'column',
        gap: 2,
        height: '100%',
        backgroundImage: gradientBg,
        backgroundColor: 'background.default'
      }}
    >
      <Box display="flex" alignItems="center" justifyContent="space-between">
        <Box display="flex" alignItems="center" gap={1}>
          <AutoAwesomeIcon fontSize="small" />
          <Box>
            <Typography variant="h6">Branding</Typography>
            <Typography variant="caption" color="text.secondary">
              Customize how this organization appears to its users.
            </Typography>
          </Box>
        </Box>
        <Button variant="contained" onClick={handleSave} disabled={loading}>
          Save changes
        </Button>
      </Box>

      <Card sx={{ borderRadius: 3 }}>
        <CardContent sx={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
          <TextField
            label="Display name"
            value={config.displayName ?? ''}
            onChange={(e) =>
              setConfig((prev) => (prev ? { ...prev, displayName: e.target.value } : prev))
            }
          />

          <TextField
            label="Logo URL"
            value={config.logoUrl ?? ''}
            onChange={(e) =>
              setConfig((prev) => (prev ? { ...prev, logoUrl: e.target.value } : prev))
            }
            helperText="Use a square PNG or SVG for best results."
          />

          <TextField
            label="Primary color (hex)"
            value={config.primaryColor ?? ''}
            onChange={(e) =>
              setConfig((prev) => (prev ? { ...prev, primaryColor: e.target.value } : prev))
            }
            helperText="Example: #0F766E"
          />

          <FormControlLabel
            control={
              <Switch
                checked={config.showLogoOnChat}
                onChange={(e) =>
                  setConfig((prev) =>
                    prev ? { ...prev, showLogoOnChat: e.target.checked } : prev
                  )
                }
              />
            }
            label="Show logo on chat pages"
          />

          {config.logoUrl && (
            <Box mt={1}>
              <Typography variant="caption" color="text.secondary">
                Preview
              </Typography>
              <Box mt={0.5} display="flex" alignItems="center" gap={1}>
                {/* eslint-disable-next-line @next/next/no-img-element */}
                <img
                  src={config.logoUrl}
                  alt="Org logo preview"
                  style={{ width: 40, height: 40, borderRadius: 12 }}
                />
                <Typography variant="body2">{config.displayName || 'Organization'}</Typography>
              </Box>
            </Box>
          )}
        </CardContent>
      </Card>
    </Box>
  );
};
```

Register routes in your router:

```tsx
import { OrgMembersPage } from './org/OrgMembersPage';
import { OrgApiKeysPage } from './org/OrgApiKeysPage';
import { OrgBrandingPage } from './org/OrgBrandingPage';

<Route path="/app/orgs/:orgId/settings/members" element={<OrgMembersPage />} />
<Route path="/app/orgs/:orgId/settings/api-keys" element={<OrgApiKeysPage />} />
<Route path="/app/orgs/:orgId/settings/branding" element={<OrgBrandingPage />} />
```

---

## 40.8. Observability, Audit & Security Notes

- **Events (38.md):**  
  - Emit events like `org.member_invited`, `org.member_role_changed`, `org.api_key_created`, `org.branding_updated`.  
  - These should appear in the Audit Log page.

- **Metrics (28.md):**  
  - `org_members_total{orgId}` – gauge updated from DB.  
  - `org_api_keys_total{orgId}` – gauge for active keys.  
  - `org_api_key_requests_total{orgId,scope}` – incremented in API key auth middleware.  
  - `org_invitations_sent_total{orgId}` – counter for invitations.

- **Security:**  
  - API keys are **hashed** at rest; raw tokens are never stored.  
  - Only org admins with `org:admin:*` permissions can manage members & keys.  
  - Branding URLs should be validated/sanitized to avoid XSS via img tags.

---

## 40.9. Sanity Checklist

Before going to production with the Admin Console:

- [ ] Prisma migrations for `OrgInvitation`, `OrgApiKey`, `OrgBrandingConfig` applied.  
- [ ] Members page lists users, invitations and allows role/status management.  
- [ ] Invitation tokens integrate with existing sign‑up / org join flow.  
- [ ] API keys can be created, copied once, used for programmatic access and revoked.  
- [ ] Branding settings update the UI theme/logo for that org.  
- [ ] All admin actions appear in the audit log and metrics are visible in Grafana.

If all checks pass, the AI chat platform now has a **full Org Admin Console** comparable to enterprise SaaS tools: member management, secure API keys and customizable branding – all wired into RBAC, audit logging and observability.

---

_End of 40.md – Org Admin Console, Members, API Keys & Branding – Backend + Material 3 UI_
