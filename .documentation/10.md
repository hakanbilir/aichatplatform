# 10. Web Chat App – Material 3 UI & Streaming Chat

> **Audience:** AI coding assistants (Cursor, Claude Code, ChatGPT, etc.) and human developers.  
> **Goal of this file:** Implement the **web frontend** (`apps/web`) for the AI chat system with:
>
> - Material 3–inspired design (using MUI theme customization).  
> - Vivid gradient header/sidebar, subtle depth, and micro‑interactions.  
> - Auth flow (signup/login) wired to the API gateway.  
> - Org selection, conversation list, and chat screen.  
> - **Streaming chat** using the SSE endpoint (`POST /conversations/:id/stream`).
>
> After following this file, a user can log in, select a conversation, type a message, and see streaming AI responses in a modern, interactive UI.

> **Important instructions to AI agents:**
> - Assume the web app lives in `apps/web`.  
> - Use React + TypeScript + Vite (standard React/Vite template).  
> - Use `@mui/material` for layout/theming, but keep custom gradient styles in local CSS.  
> - Do **not** leave any TODOs or commented‑out placeholders.  
> - Ensure all imports match the file structure declared below.

---

## 10.1. Tech Stack & Folder Structure

### 10.1.1. Stack

- **React 19 + TypeScript**  
- **Vite** as bundler (React template)  
- **MUI (Material UI)** for Material‑like components and theme  
- **React Router** for simple routing (`/auth`, `/app`)  
- **SSE streaming via `fetch` + `ReadableStream`** (because our SSE endpoint is `POST`)  

### 10.1.2. Frontend Folder Structure

Under `apps/web` we assume / enforce:

```text
apps/web/
  index.html
  vite.config.ts
  tsconfig.json
  package.json
  src/
    main.tsx
    App.tsx
    router.tsx

    api/
      client.ts
      auth.ts
      conversations.ts
      chat.ts

    auth/
      AuthContext.tsx
      RequireAuth.tsx
      LoginPage.tsx
      SignupPage.tsx

    layout/
      Shell.tsx
      TopBar.tsx
      OrgSwitcher.tsx
      SideNav.tsx

    chat/
      ChatPage.tsx
      ConversationList.tsx
      ChatView.tsx
      MessageInput.tsx
      MessageBubble.tsx

    theme/
      theme.ts

    styles/
      gradients.css
```

All these files will be defined or updated in this document.

---

## 10.2. `apps/web/package.json`

Replace `apps/web/package.json` with the following content:

```json
{
  "name": "web",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview",
    "lint": "eslint src --ext .ts,.tsx",
    "test": "echo \"no tests yet\""
  },
  "dependencies": {
    "@mui/icons-material": "^6.0.0",
    "@mui/material": "^6.0.0",
    "@emotion/react": "^11.13.0",
    "@emotion/styled": "^11.13.0",
    "react": "^19.0.0",
    "react-dom": "^19.0.0",
    "react-router-dom": "^7.0.0"
  },
  "devDependencies": {
    "@types/react": "^19.0.0",
    "@types/react-dom": "^19.0.0",
    "@vitejs/plugin-react": "^4.0.0",
    "typescript": "^5.7.0",
    "vite": "^6.0.0"
  }
}
```

> **AI Agent Note:**  
> After editing `package.json`, run `pnpm install` at the repo root so the workspace picks up these dependencies.

---

## 10.3. Vite & TypeScript Config

If not already present, ensure the following minimal configurations.

### 10.3.1. `apps/web/vite.config.ts`

Replace or create `apps/web/vite.config.ts`:

```ts
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [react()],
  server: {
    port: 5173
  }
});
```

### 10.3.2. `apps/web/tsconfig.json`

Replace or create `apps/web/tsconfig.json`:

```json
{
  "extends": "../../tsconfig.base.json",
  "compilerOptions": {
    "jsx": "react-jsx",
    "baseUrl": "./src"
  },
  "include": ["src"]
}
```

---

## 10.4. Global Theme & Gradients

We create a Material 3–inspired theme and a gradients stylesheet for vivid backgrounds.

### 10.4.1. `apps/web/src/theme/theme.ts`

Create `apps/web/src/theme/theme.ts`:

```ts
import { createTheme } from '@mui/material/styles';

// Material 3–inspired color tokens with vivid gradients in CSS
export const theme = createTheme({
  palette: {
    mode: 'dark',
    primary: {
      main: '#7C4DFF'
    },
    secondary: {
      main: '#00E5FF'
    },
    background: {
      default: '#050711',
      paper: '#101322'
    },
    text: {
      primary: '#FFFFFF',
      secondary: '#B0B3C3'
    }
  },
  shape: {
    borderRadius: 16
  },
  components: {
    MuiPaper: {
      styleOverrides: {
        root: {
          borderRadius: 16,
          backgroundImage: 'linear-gradient(135deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02))',
          backdropFilter: 'blur(16px)',
          border: '1px solid rgba(255,255,255,0.08)'
        }
      }
    },
    MuiButton: {
      defaultProps: {
        disableRipple: false
      },
      styleOverrides: {
        root: {
          textTransform: 'none',
          borderRadius: 999,
          transition: 'transform 120ms ease, box-shadow 120ms ease',
          '&:hover': {
            transform: 'translateY(-1px)',
            boxShadow: '0 10px 30px rgba(0,0,0,0.4)'
          },
          '&:active': {
            transform: 'translateY(0)',
            boxShadow: '0 4px 16px rgba(0,0,0,0.6)'
          }
        }
      }
    }
  }
});
```

### 10.4.2. `apps/web/src/styles/gradients.css`

Create `apps/web/src/styles/gradients.css`:

```css
:root {
  --gradient-primary: radial-gradient(circle at 0% 0%, #7c4dff 0%, #00e5ff 40%, #ff4081 90%);
  --gradient-sidebar: linear-gradient(180deg, rgba(124, 77, 255, 0.8), rgba(0, 229, 255, 0.4));
  --gradient-header: linear-gradient(90deg, rgba(124, 77, 255, 0.9), rgba(0, 229, 255, 0.8));
}

html,
body,
#root {
  margin: 0;
  padding: 0;
  height: 100%;
}

body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Roboto', sans-serif;
  background: radial-gradient(circle at top left, #111427 0%, #050711 45%, #000000 100%);
}

.gradient-shell {
  background: radial-gradient(circle at top left, rgba(124, 77, 255, 0.28), transparent 55%),
    radial-gradient(circle at bottom right, rgba(0, 229, 255, 0.18), transparent 55%),
    #050711;
}

.gradient-sidebar {
  background: var(--gradient-sidebar);
}

.gradient-header {
  background: var(--gradient-header);
}

.micro-elevated {
  box-shadow: 0 18px 45px rgba(0, 0, 0, 0.6);
  transition: box-shadow 160ms ease, transform 160ms ease;
}

.micro-elevated:hover {
  transform: translateY(-2px);
  box-shadow: 0 26px 65px rgba(0, 0, 0, 0.8);
}

.micro-fade-in {
  animation: micro-fade-in 220ms ease-out;
}

@keyframes micro-fade-in {
  from {
    opacity: 0;
    transform: translateY(4px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
```

---

## 10.5. API Client Layer

We create a small fetch wrapper and specific client modules for auth, orgs, conversations, and chat.

### 10.5.1. `apps/web/src/api/client.ts`

Create `apps/web/src/api/client.ts`:

```ts
const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:4000';

export interface ApiError {
  status: number;
  message: string;
  details?: unknown;
}

export async function apiRequest<T>(
  path: string,
  options: RequestInit = {},
  token?: string | null
): Promise<T> {
  const url = `${API_BASE_URL}${path}`;

  const headers: HeadersInit = {
    'Content-Type': 'application/json',
    ...(options.headers || {})
  };

  if (token) {
    (headers as Record<string, string>)['Authorization'] = `Bearer ${token}`;
  }

  const response = await fetch(url, {
    ...options,
    headers
  });

  const isJson = response.headers.get('content-type')?.includes('application/json');
  const body = isJson ? await response.json().catch(() => undefined) : undefined;

  if (!response.ok) {
    const error: ApiError = {
      status: response.status,
      message: (body as any)?.error || response.statusText,
      details: (body as any)?.details
    };
    throw error;
  }

  return body as T;
}
```

### 10.5.2. `apps/web/src/api/auth.ts`

Create `apps/web/src/api/auth.ts`:

```ts
import { apiRequest } from './client';

export interface AuthUser {
  id: string;
  email: string;
  name: string | null;
  isSuperadmin: boolean;
}

export interface OrganizationSummary {
  id: string;
  name: string;
  slug: string;
  role?: string;
}

export interface AuthResponse {
  token: string;
  user: AuthUser;
  activeOrg: OrganizationSummary | null;
  organizations?: OrganizationSummary[];
}

export async function signup(data: {
  email: string;
  password: string;
  name: string;
  orgName?: string;
}): Promise<AuthResponse> {
  return apiRequest<AuthResponse>('/auth/signup', {
    method: 'POST',
    body: JSON.stringify(data)
  });
}

export async function login(data: { email: string; password: string }): Promise<AuthResponse> {
  return apiRequest<AuthResponse>('/auth/login', {
    method: 'POST',
    body: JSON.stringify(data)
  });
}

export interface MeResponse {
  user: AuthUser;
  activeOrg: OrganizationSummary | null;
  organizations: OrganizationSummary[];
}

export async function getMe(token: string): Promise<MeResponse> {
  return apiRequest<MeResponse>('/auth/me', { method: 'GET' }, token);
}

export async function getOrganizations(token: string): Promise<{ organizations: OrganizationSummary[] }> {
  return apiRequest<{ organizations: OrganizationSummary[] }>('/orgs', { method: 'GET' }, token);
}
```

### 10.5.3. `apps/web/src/api/conversations.ts`

Create `apps/web/src/api/conversations.ts`:

```ts
import { apiRequest } from './client';

export interface ConversationListItem {
  id: string;
  title: string | null;
  model: string | null;
  createdAt: string;
  updatedAt: string;
  orgId: string | null;
}

export interface ConversationDetails {
  id: string;
  title: string | null;
  model: string | null;
  systemPrompt: string | null;
  temperature: number | null;
  topP: number | null;
  createdAt: string;
  updatedAt: string;
  orgId: string | null;
  messages: Array<{
    id: string;
    role: string;
    content: string;
    createdAt: string;
  }>;
}

export async function listConversations(token: string): Promise<{ conversations: ConversationListItem[] }> {
  return apiRequest<{ conversations: ConversationListItem[] }>('/conversations', { method: 'GET' }, token);
}

export async function createConversation(
  token: string,
  data: { title?: string; systemPrompt?: string; model?: string; temperature?: number; topP?: number }
): Promise<ConversationListItem> {
  const result = await apiRequest<ConversationListItem>('/conversations', {
    method: 'POST',
    body: JSON.stringify(data)
  }, token);
  return result;
}

export async function getConversation(token: string, id: string): Promise<{ conversation: ConversationDetails }> {
  return apiRequest<{ conversation: ConversationDetails }>(`/conversations/${id}`, { method: 'GET' }, token);
}
```

### 10.5.4. `apps/web/src/api/chat.ts`

Create `apps/web/src/api/chat.ts`:

```ts
import { apiRequest } from './client';

export interface SendMessageResponse {
  conversationId: string;
  userMessage: {
    id: string;
    role: string;
    content: string;
    createdAt: string;
  };
  assistantMessage: {
    id: string;
    role: string;
    content: string;
    createdAt: string;
  };
  usage?: {
    promptTokens: number;
    completionTokens: number;
    totalTokens: number;
  };
}

export async function sendMessage(
  token: string,
  conversationId: string,
  data: { content: string; model?: string; temperature?: number; topP?: number; maxTokens?: number }
): Promise<SendMessageResponse> {
  return apiRequest<SendMessageResponse>(`/conversations/${conversationId}/messages`, {
    method: 'POST',
    body: JSON.stringify(data)
  }, token);
}

export type StreamEvent =
  | { type: 'start' }
  | { type: 'token'; token: string }
  | { type: 'end'; message: { role: string; content: string }; usage?: { promptTokens: number; completionTokens: number; totalTokens: number } }
  | { type: 'error'; error: string };

/**
 * Streaming chat helper using fetch + ReadableStream.
 *
 * onEvent is called for each parsed SSE event.
 */
export async function streamMessage(
  token: string,
  conversationId: string,
  data: { content: string; model?: string; temperature?: number; topP?: number; maxTokens?: number },
  onEvent: (event: StreamEvent) => void,
  signal?: AbortSignal
): Promise<void> {
  const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:4000';
  const url = `${API_BASE_URL}/conversations/${conversationId}/stream`;

  const response = await fetch(url, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      Authorization: `Bearer ${token}`
    },
    body: JSON.stringify(data),
    signal
  });

  if (!response.ok || !response.body) {
    onEvent({ type: 'error', error: `HTTP ${response.status} ${response.statusText}` });
    return;
  }

  const reader = response.body.getReader();
  const decoder = new TextDecoder();
  let buffer = '';

  onEvent({ type: 'start' });

  // eslint-disable-next-line no-constant-condition
  while (true) {
    const { done, value } = await reader.read();
    if (done) break;

    buffer += decoder.decode(value, { stream: true });

    const lines = buffer.split('\n');
    buffer = lines.pop() ?? '';

    for (const line of lines) {
      const trimmed = line.trim();
      if (!trimmed.startsWith('data:')) continue;
      const jsonPart = trimmed.slice('data:'.length).trim();
      if (!jsonPart) continue;

      try {
        const evt = JSON.parse(jsonPart) as StreamEvent;
        onEvent(evt);
      } catch (err) {
        onEvent({ type: 'error', error: (err as Error).message });
      }
    }
  }
}
```

---

## 10.6. Auth Context & Pages

We manage auth state globally and provide simple login/signup screens.

### 10.6.1. `apps/web/src/auth/AuthContext.tsx`

Create `apps/web/src/auth/AuthContext.tsx`:

```tsx
import React, { createContext, useContext, useEffect, useState } from 'react';
import type { AuthUser, AuthResponse, MeResponse } from '../api/auth';
import { getMe } from '../api/auth';

interface AuthState {
  token: string | null;
  user: AuthUser | null;
  loading: boolean;
}

interface AuthContextValue extends AuthState {
  setAuthFromResponse: (resp: AuthResponse) => void;
  logout: () => void;
}

const AuthContext = createContext<AuthContextValue | undefined>(undefined);

const STORAGE_KEY = 'ai_chat_auth_token';

export const AuthProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [token, setToken] = useState<string | null>(() => {
    if (typeof window === 'undefined') return null;
    return window.localStorage.getItem(STORAGE_KEY);
  });
  const [user, setUser] = useState<AuthUser | null>(null);
  const [loading, setLoading] = useState<boolean>(true);

  useEffect(() => {
    let cancelled = false;

    async function load() {
      if (!token) {
        setUser(null);
        setLoading(false);
        return;
      }

      try {
        const me: MeResponse = await getMe(token);
        if (!cancelled) {
          setUser(me.user);
        }
      } catch {
        if (!cancelled) {
          setUser(null);
          setToken(null);
          if (typeof window !== 'undefined') {
            window.localStorage.removeItem(STORAGE_KEY);
          }
        }
      } finally {
        if (!cancelled) {
          setLoading(false);
        }
      }
    }

    load();

    return () => {
      cancelled = true;
    };
  }, [token]);

  const setAuthFromResponse = (resp: AuthResponse) => {
    setToken(resp.token);
    setUser(resp.user);
    if (typeof window !== 'undefined') {
      window.localStorage.setItem(STORAGE_KEY, resp.token);
    }
  };

  const logout = () => {
    setToken(null);
    setUser(null);
    if (typeof window !== 'undefined') {
      window.localStorage.removeItem(STORAGE_KEY);
    }
  };

  return (
    <AuthContext.Provider
      value={{
        token,
        user,
        loading,
        setAuthFromResponse,
        logout
      }}
    >
      {children}
    </AuthContext.Provider>
  );
};

export function useAuth(): AuthContextValue {
  const ctx = useContext(AuthContext);
  if (!ctx) {
    throw new Error('useAuth must be used within AuthProvider');
  }
  return ctx;
}
```

### 10.6.2. `apps/web/src/auth/RequireAuth.tsx`

Create `apps/web/src/auth/RequireAuth.tsx`:

```tsx
import React from 'react';
import { Navigate, useLocation } from 'react-router-dom';
import { useAuth } from './AuthContext';
import { CircularProgress, Box } from '@mui/material';

export const RequireAuth: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const { token, loading } = useAuth();
  const location = useLocation();

  if (loading) {
    return (
      <Box display="flex" alignItems="center" justifyContent="center" height="100vh">
        <CircularProgress />
      </Box>
    );
  }

  if (!token) {
    return <Navigate to="/auth/login" state={{ from: location }} replace />;
  }

  return <>{children}</>;
};
```

### 10.6.3. `apps/web/src/auth/LoginPage.tsx`

Create `apps/web/src/auth/LoginPage.tsx`:

```tsx
import React, { useState } from 'react';
import { useNavigate, Link as RouterLink } from 'react-router-dom';
import { Box, Button, TextField, Typography, Paper, Link } from '@mui/material';
import { login } from '../api/auth';
import { useAuth } from './AuthContext';

export const LoginPage: React.FC = () => {
  const { setAuthFromResponse } = useAuth();
  const navigate = useNavigate();

  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError(null);
    try {
      const resp = await login({ email, password });
      setAuthFromResponse(resp);
      navigate('/app');
    } catch (err) {
      const message = (err as any)?.message || 'Login failed';
      setError(message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <Box
      minHeight="100vh"
      display="flex"
      alignItems="center"
      justifyContent="center"
      className="gradient-shell"
    >
      <Paper className="micro-elevated" sx={{ p: 4, width: 380 }}>
        <Typography variant="h5" gutterBottom>
          Welcome back
        </Typography>
        <Typography variant="body2" color="text.secondary" gutterBottom>
          Sign in to your AI workspace.
        </Typography>
        <Box component="form" onSubmit={handleSubmit} mt={2}>
          <TextField
            label="Email"
            type="email"
            fullWidth
            margin="normal"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            required
          />
          <TextField
            label="Password"
            type="password"
            fullWidth
            margin="normal"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            required
          />
          {error && (
            <Typography color="error" variant="body2" mt={1}>
              {error}
            </Typography>
          )}
          <Button
            type="submit"
            fullWidth
            variant="contained"
            sx={{ mt: 3 }}
            disabled={loading}
          >
            {loading ? 'Signing in…' : 'Sign in'}
          </Button>
        </Box>
        <Box mt={2}>
          <Typography variant="body2">
            Don&apos;t have an account?{' '}
            <Link component={RouterLink} to="/auth/signup">
              Sign up
            </Link>
          </Typography>
        </Box>
      </Paper>
    </Box>
  );
};
```

### 10.6.4. `apps/web/src/auth/SignupPage.tsx`

Create `apps/web/src/auth/SignupPage.tsx`:

```tsx
import React, { useState } from 'react';
import { useNavigate, Link as RouterLink } from 'react-router-dom';
import { Box, Button, TextField, Typography, Paper, Link } from '@mui/material';
import { signup } from '../api/auth';
import { useAuth } from './AuthContext';

export const SignupPage: React.FC = () => {
  const { setAuthFromResponse } = useAuth();
  const navigate = useNavigate();

  const [name, setName] = useState('');
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [orgName, setOrgName] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError(null);
    try {
      const resp = await signup({ email, password, name, orgName: orgName || undefined });
      setAuthFromResponse(resp);
      navigate('/app');
    } catch (err) {
      const message = (err as any)?.message || 'Signup failed';
      setError(message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <Box
      minHeight="100vh"
      display="flex"
      alignItems="center"
      justifyContent="center"
      className="gradient-shell"
    >
      <Paper className="micro-elevated" sx={{ p: 4, width: 420 }}>
        <Typography variant="h5" gutterBottom>
          Create your workspace
        </Typography>
        <Typography variant="body2" color="text.secondary" gutterBottom>
          Sign up and start chatting with your Ollama‑powered assistant.
        </Typography>
        <Box component="form" onSubmit={handleSubmit} mt={2}>
          <TextField
            label="Full name"
            fullWidth
            margin="normal"
            value={name}
            onChange={(e) => setName(e.target.value)}
            required
          />
          <TextField
            label="Email"
            type="email"
            fullWidth
            margin="normal"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            required
          />
          <TextField
            label="Password"
            type="password"
            fullWidth
            margin="normal"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            required
          />
          <TextField
            label="Workspace name (optional)"
            fullWidth
            margin="normal"
            value={orgName}
            onChange={(e) => setOrgName(e.target.value)}
          />
          {error && (
            <Typography color="error" variant="body2" mt={1}>
              {error}
            </Typography>
          )}
          <Button
            type="submit"
            fullWidth
            variant="contained"
            sx={{ mt: 3 }}
            disabled={loading}
          >
            {loading ? 'Creating…' : 'Sign up'}
          </Button>
        </Box>
        <Box mt={2}>
          <Typography variant="body2">
            Already have an account?{' '}
            <Link component={RouterLink} to="/auth/login">
              Sign in
            </Link>
          </Typography>
        </Box>
      </Paper>
    </Box>
  );
};
```

---

## 10.7. Layout Shell & Navigation

We build the main app shell: gradient top bar, sidebar with org + conversations, and chat content.

### 10.7.1. `apps/web/src/layout/TopBar.tsx`

Create `apps/web/src/layout/TopBar.tsx`:

```tsx
import React from 'react';
import { AppBar, Toolbar, Typography, Box, IconButton, Avatar } from '@mui/material';
import LogoutIcon from '@mui/icons-material/Logout';
import { useAuth } from '../auth/AuthContext';

export const TopBar: React.FC = () => {
  const { user, logout } = useAuth();

  const initials = user?.name?.[0]?.toUpperCase() || user?.email[0]?.toUpperCase() || 'A';

  return (
    <AppBar position="static" elevation={0} className="gradient-header" sx={{ mb: 1 }}>
      <Toolbar sx={{ display: 'flex', justifyContent: 'space-between' }}>
        <Box display="flex" alignItems="center" gap={1.5}>
          <Box
            sx={{
              width: 32,
              height: 32,
              borderRadius: '50%',
              background: 'radial-gradient(circle at 30% 0%, #fff, transparent 60%)',
              border: '1px solid rgba(255,255,255,0.4)'
            }}
          />
          <Box>
            <Typography variant="subtitle1" fontWeight={600}>
              AI Studio
            </Typography>
            <Typography variant="caption" color="text.secondary">
              Ollama‑powered chat
            </Typography>
          </Box>
        </Box>
        <Box display="flex" alignItems="center" gap={1.5}>
          {user && (
            <>
              <Typography variant="body2" color="text.secondary">
                {user.email}
              </Typography>
              <Avatar sx={{ width: 30, height: 30, fontSize: 14 }}>{initials}</Avatar>
            </>
          )}
          <IconButton color="inherit" size="small" onClick={logout}>
            <LogoutIcon fontSize="small" />
          </IconButton>
        </Box>
      </Toolbar>
    </AppBar>
  );
};
```

### 10.7.2. `apps/web/src/layout/OrgSwitcher.tsx`

Create `apps/web/src/layout/OrgSwitcher.tsx`:

```tsx
import React, { useEffect, useState } from 'react';
import { Box, MenuItem, Select, Typography } from '@mui/material';
import type { OrganizationSummary } from '../api/auth';
import { getOrganizations } from '../api/auth';
import { useAuth } from '../auth/AuthContext';

export const OrgSwitcher: React.FC = () => {
  const { token } = useAuth();
  const [orgs, setOrgs] = useState<OrganizationSummary[]>([]);

  useEffect(() => {
    if (!token) return;
    let cancelled = false;

    async function load() {
      try {
        const resp = await getOrganizations(token);
        if (!cancelled) setOrgs(resp.organizations);
      } catch {
        // ignore
      }
    }

    load();

    return () => {
      cancelled = true;
    };
  }, [token]);

  return (
    <Box mb={2}>
      <Typography variant="caption" color="rgba(255,255,255,0.75)">
        Workspace
      </Typography>
      <Select
        fullWidth
        size="small"
        value={orgs[0]?.id ?? ''}
        sx={{
          mt: 0.5,
          fontSize: 13,
          '& .MuiSelect-select': {
            paddingY: 0.8
          }
        }}
        displayEmpty
        renderValue={(value) => {
          if (!value || orgs.length === 0) {
            return <span>No orgs</span>;
          }
          const org = orgs.find((o) => o.id === value) ?? orgs[0];
          return `${org.name}`;
        }}
      >
        {orgs.map((org) => (
          <MenuItem key={org.id} value={org.id}>
            {org.name}
          </MenuItem>
        ))}
      </Select>
    </Box>
  );
};
```

> **Note:** Active org switching on the backend requires additional endpoints; here we only display current memberships.

### 10.7.3. `apps/web/src/layout/SideNav.tsx`

Create `apps/web/src/layout/SideNav.tsx`:

```tsx
import React from 'react';
import { Box, Button, Typography } from '@mui/material';
import AddIcon from '@mui/icons-material/Add';
import { OrgSwitcher } from './OrgSwitcher';
import { ConversationList } from '../chat/ConversationList';

interface SideNavProps {
  onCreateConversation: () => void;
}

export const SideNav: React.FC<SideNavProps> = ({ onCreateConversation }) => {
  return (
    <Box
      className="gradient-sidebar"
      sx={{
        width: 280,
        display: 'flex',
        flexDirection: 'column',
        padding: 2,
        color: 'white',
        borderRight: '1px solid rgba(255,255,255,0.15)'
      }}
    >
      <OrgSwitcher />
      <Button
        variant="contained"
        startIcon={<AddIcon />}
        size="small"
        onClick={onCreateConversation}
        sx={{ mb: 2 }}
      >
        New chat
      </Button>
      <Typography variant="caption" sx={{ mb: 1, opacity: 0.8 }}>
        Recent conversations
      </Typography>
      <Box flex={1} overflow="auto">
        <ConversationList />
      </Box>
    </Box>
  );
};
```

### 10.7.4. `apps/web/src/layout/Shell.tsx`

Create `apps/web/src/layout/Shell.tsx`:

```tsx
import React from 'react';
import { Box } from '@mui/material';
import { TopBar } from './TopBar';
import { SideNav } from './SideNav';
import { ChatPage } from '../chat/ChatPage';

export const Shell: React.FC = () => {
  const handleCreateConversation = () => {
    const event = new CustomEvent('create-conversation');
    window.dispatchEvent(event);
  };

  return (
    <Box className="gradient-shell" sx={{ minHeight: '100vh', display: 'flex', flexDirection: 'column' }}>
      <TopBar />
      <Box sx={{ flex: 1, display: 'flex', overflow: 'hidden' }}>
        <SideNav onCreateConversation={handleCreateConversation} />
        <Box flex={1} display="flex" flexDirection="column">
          <ChatPage />
        </Box>
      </Box>
    </Box>
  );
};
```

---

## 10.8. Chat UI Components

We implement the conversation list, main chat view, message bubbles, and input with streaming integration.

### 10.8.1. `apps/web/src/chat/ConversationList.tsx`

Create `apps/web/src/chat/ConversationList.tsx`:

```tsx
import React, { useEffect, useState } from 'react';
import { Box, List, ListItemButton, ListItemText, Typography } from '@mui/material';
import { listConversations, ConversationListItem } from '../api/conversations';
import { useAuth } from '../auth/AuthContext';

interface ConversationListProps {}

export const ConversationList: React.FC<ConversationListProps> = () => {
  const { token } = useAuth();
  const [items, setItems] = useState<ConversationListItem[]>([]);
  const [selectedId, setSelectedId] = useState<string | null>(null);

  useEffect(() => {
    if (!token) return;
    let cancelled = false;

    async function load() {
      try {
        const resp = await listConversations(token);
        if (!cancelled) {
          setItems(resp.conversations);
          if (!selectedId && resp.conversations.length > 0) {
            setSelectedId(resp.conversations[0].id);
            const event = new CustomEvent('select-conversation', { detail: resp.conversations[0].id });
            window.dispatchEvent(event);
          }
        }
      } catch {
        // ignore errors
      }
    }

    load();

    const handler = (e: Event) => {
      const detail = (e as CustomEvent<string>).detail;
      if (!detail) return;
      setItems((prev) => [
        {
          id: detail,
          title: 'New Conversation',
          model: 'llama3.1',
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString(),
          orgId: null
        },
        ...prev
      ]);
      setSelectedId(detail);
    };

    window.addEventListener('conversation-created', handler);

    return () => {
      cancelled = true;
      window.removeEventListener('conversation-created', handler);
    };
  }, [token, selectedId]);

  const handleSelect = (id: string) => {
    setSelectedId(id);
    const event = new CustomEvent('select-conversation', { detail: id });
    window.dispatchEvent(event);
  };

  if (!token) {
    return null;
  }

  if (items.length === 0) {
    return (
      <Box mt={2}>
        <Typography variant="body2" color="rgba(255,255,255,0.8)">
          No conversations yet.
        </Typography>
        <Typography variant="caption" color="rgba(255,255,255,0.6)">
          Start a new chat to see it here.
        </Typography>
      </Box>
    );
  }

  return (
    <List dense disablePadding>
      {items.map((c) => (
        <ListItemButton
          key={c.id}
          selected={c.id === selectedId}
          onClick={() => handleSelect(c.id)}
          sx={{ borderRadius: 2, mb: 0.5 }}
        >
          <ListItemText
            primary={c.title || 'Untitled'}
            secondary={new Date(c.updatedAt).toLocaleTimeString()}
            primaryTypographyProps={{ noWrap: true, fontSize: 13 }}
            secondaryTypographyProps={{ noWrap: true, fontSize: 11 }}
          />
        </ListItemButton>
      ))}
    </List>
  );
};
```

### 10.8.2. `apps/web/src/chat/MessageBubble.tsx`

Create `apps/web/src/chat/MessageBubble.tsx`:

```tsx
import React from 'react';
import { Box, Typography } from '@mui/material';

interface MessageBubbleProps {
  role: 'user' | 'assistant';
  content: string;
}

export const MessageBubble: React.FC<MessageBubbleProps> = ({ role, content }) => {
  const isUser = role === 'user';
  return (
    <Box
      display="flex"
      justifyContent={isUser ? 'flex-end' : 'flex-start'}
      mb={1.2}
      className="micro-fade-in"
    >
      <Box
        sx={{
          maxWidth: '80%',
          px: 1.8,
          py: 1.2,
          borderRadius: 3,
          bgcolor: isUser ? 'primary.main' : 'rgba(15,17,35,0.9)',
          color: 'white',
          border: isUser ? 'none' : '1px solid rgba(255,255,255,0.12)',
          boxShadow: isUser ? '0 14px 36px rgba(124,77,255,0.6)' : '0 10px 24px rgba(0,0,0,0.65)'
        }}
      >
        <Typography variant="body2" sx={{ whiteSpace: 'pre-wrap' }}>
          {content}
        </Typography>
      </Box>
    </Box>
  );
};
```

### 10.8.3. `apps/web/src/chat/MessageInput.tsx`

Create `apps/web/src/chat/MessageInput.tsx`:

```tsx
import React, { useState } from 'react';
import { Box, IconButton, TextField, CircularProgress } from '@mui/material';
import SendIcon from '@mui/icons-material/Send';

interface MessageInputProps {
  disabled?: boolean;
  onSend: (content: string) => void;
}

export const MessageInput: React.FC<MessageInputProps> = ({ disabled, onSend }) => {
  const [value, setValue] = useState('');
  const [submitting, setSubmitting] = useState(false);

  const handleSend = async () => {
    if (!value.trim() || disabled) return;
    const content = value;
    setSubmitting(true);
    try {
      await onSend(content);
      setValue('');
    } finally {
      setSubmitting(false);
    }
  };

  const handleKeyDown = (e: React.KeyboardEvent<HTMLDivElement>) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      void handleSend();
    }
  };

  return (
    <Box display="flex" alignItems="center" gap={1} px={2} py={1.2} borderTop="1px solid rgba(255,255,255,0.12)">
      <TextField
        fullWidth
        multiline
        maxRows={5}
        placeholder="Send a message…"
        value={value}
        onChange={(e) => setValue(e.target.value)}
        onKeyDown={handleKeyDown}
        disabled={disabled}
        variant="outlined"
        size="small"
      />
      <IconButton
        color="primary"
        disabled={disabled || submitting}
        onClick={handleSend}
        sx={{
          width: 40,
          height: 40,
          borderRadius: '50%',
          bgcolor: 'rgba(255,255,255,0.06)'
        }}
      >
        {submitting ? <CircularProgress size={20} /> : <SendIcon />}
      </IconButton>
    </Box>
  );
};
```

### 10.8.4. `apps/web/src/chat/ChatView.tsx`

Create `apps/web/src/chat/ChatView.tsx`:

```tsx
import React from 'react';
import { Box, Typography } from '@mui/material';
import { MessageBubble } from './MessageBubble';

interface ChatViewProps {
  messages: Array<{ id: string; role: string; content: string }>;
  streamingAssistantText: string;
}

export const ChatView: React.FC<ChatViewProps> = ({ messages, streamingAssistantText }) => {
  const allMessages = [...messages];

  if (streamingAssistantText) {
    allMessages.push({ id: 'streaming', role: 'assistant', content: streamingAssistantText });
  }

  if (allMessages.length === 0) {
    return (
      <Box
        flex={1}
        display="flex"
        flexDirection="column"
        alignItems="center"
        justifyContent="center"
        sx={{ opacity: 0.8 }}
      >
        <Typography variant="h6" gutterBottom>
          Start a new conversation
        </Typography>
        <Typography variant="body2" color="text.secondary">
          Ask anything. Responses are streamed from your Ollama backend.
        </Typography>
      </Box>
    );
  }

  return (
    <Box flex={1} overflow="auto" px={3} py={2}>
      {allMessages.map((m) => (
        <MessageBubble key={m.id} role={m.role === 'USER' || m.role === 'user' ? 'user' : 'assistant'} content={m.content} />
      ))}
    </Box>
  );
};
```

### 10.8.5. `apps/web/src/chat/ChatPage.tsx`

Create `apps/web/src/chat/ChatPage.tsx`:

```tsx
import React, { useEffect, useState, useRef } from 'react';
import { Box } from '@mui/material';
import { useAuth } from '../auth/AuthContext';
import { ConversationDetails, getConversation } from '../api/conversations';
import { sendMessage, streamMessage, StreamEvent } from '../api/chat';
import { ChatView } from './ChatView';
import { MessageInput } from './MessageInput';

export const ChatPage: React.FC = () => {
  const { token } = useAuth();
  const [conversationId, setConversationId] = useState<string | null>(null);
  const [conversation, setConversation] = useState<ConversationDetails | null>(null);
  const [streamingText, setStreamingText] = useState('');
  const [streaming, setStreaming] = useState(false);
  const abortRef = useRef<AbortController | null>(null);

  useEffect(() => {
    const handleSelect = (e: Event) => {
      const id = (e as CustomEvent<string>).detail;
      setConversationId(id);
    };

    const handleCreated = (e: Event) => {
      const id = (e as CustomEvent<string>).detail;
      setConversationId(id);
    };

    window.addEventListener('select-conversation', handleSelect);
    window.addEventListener('conversation-created', handleCreated);

    return () => {
      window.removeEventListener('select-conversation', handleSelect);
      window.removeEventListener('conversation-created', handleCreated);
    };
  }, []);

  useEffect(() => {
    if (!token || !conversationId) {
      setConversation(null);
      return;
    }

    let cancelled = false;

    async function load() {
      try {
        const resp = await getConversation(token, conversationId);
        if (!cancelled) {
          setConversation(resp.conversation);
          setStreamingText('');
        }
      } catch {
        if (!cancelled) setConversation(null);
      }
    }

    load();

    return () => {
      cancelled = true;
    };
  }, [token, conversationId]);

  const handleSend = async (content: string) => {
    if (!token || !conversationId) return;

    if (!conversation) {
      return;
    }

    if (abortRef.current) {
      abortRef.current.abort();
    }

    const localConversationId = conversationId;

    // Optimistically append user message locally
    const userMessage = {
      id: `local-${Date.now()}`,
      role: 'USER',
      content
    };

    setConversation((prev) =>
      prev
        ? {
            ...prev,
            messages: [...prev.messages, { ...userMessage, createdAt: new Date().toISOString() }]
          }
        : prev
    );

    setStreamingText('');
    setStreaming(true);

    const controller = new AbortController();
    abortRef.current = controller;

    try {
      await streamMessage(
        token,
        localConversationId,
        { content },
        (event: StreamEvent) => {
          if (event.type === 'token') {
            setStreamingText((prev) => prev + event.token);
          }

          if (event.type === 'end' && event.message) {
            setStreamingText('');
            setConversation((prev) =>
              prev
                ? {
                    ...prev,
                    messages: [
                      ...prev.messages,
                      {
                        id: `assistant-${Date.now()}`,
                        role: 'ASSISTANT',
                        content: event.message.content,
                        createdAt: new Date().toISOString()
                      }
                    ]
                  }
                : prev
            );
          }
        },
        controller.signal
      );
    } finally {
      setStreaming(false);
    }

    // Optionally refresh from backend to align IDs and usage
    if (token && localConversationId) {
      try {
        const resp = await getConversation(token, localConversationId);
        setConversation(resp.conversation);
      } catch {
        // ignore
      }
    }
  };

  return (
    <Box display="flex" flexDirection="column" flex={1}>
      <ChatView messages={conversation?.messages ?? []} streamingAssistantText={streamingText} />
      <MessageInput disabled={!conversationId || streaming} onSend={handleSend} />
    </Box>
  );
};
```

> **Note:** For simplicity, we treat each streaming run as a single assistant message and refresh from the backend at the end to sync real message IDs and usage.

---

## 10.9. App Entry & Routing

Finally, we wire everything together in `main.tsx`, `App.tsx`, and `router.tsx`.

### 10.9.1. `apps/web/src/router.tsx`

Create `apps/web/src/router.tsx`:

```tsx
import React from 'react';
import { createBrowserRouter, RouterProvider } from 'react-router-dom';
import { LoginPage } from './auth/LoginPage';
import { SignupPage } from './auth/SignupPage';
import { RequireAuth } from './auth/RequireAuth';
import { Shell } from './layout/Shell';

const router = createBrowserRouter([
  {
    path: '/auth/login',
    element: <LoginPage />
  },
  {
    path: '/auth/signup',
    element: <SignupPage />
  },
  {
    path: '/app',
    element: (
      <RequireAuth>
        <Shell />
      </RequireAuth>
    )
  },
  {
    path: '*',
    element: <LoginPage />
  }
]);

export const AppRouter: React.FC = () => {
  return <RouterProvider router={router} />;
};
```

### 10.9.2. `apps/web/src/App.tsx`

Create `apps/web/src/App.tsx`:

```tsx
import React from 'react';
import { ThemeProvider, CssBaseline } from '@mui/material';
import { theme } from './theme/theme';
import { AuthProvider } from './auth/AuthContext';
import { AppRouter } from './router';
import './styles/gradients.css';

export const App: React.FC = () => {
  return (
    <ThemeProvider theme={theme}>
      <CssBaseline />
      <AuthProvider>
        <AppRouter />
      </AuthProvider>
    </ThemeProvider>
  );
};
```

### 10.9.3. `apps/web/src/main.tsx`

Create or replace `apps/web/src/main.tsx`:

```tsx
import React from 'react';
import ReactDOM from 'react-dom/client';
import { App } from './App';

ReactDOM.createRoot(document.getElementById('root') as HTMLElement).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);
```

---

## 10.10. Sanity Checks & Running the Web App

From the repo root:

1. **Install frontend dependencies (once):**

   ```bash
   pnpm install
   ```

2. **Ensure API gateway is running** (from previous docs):

   ```bash
   pnpm dev --filter=api-gateway
   ```

3. **Set frontend env for API base URL (optional if using default):**

   In `apps/web/.env`:

   ```bash
   VITE_API_BASE_URL=http://localhost:4000
   ```

4. **Run the web app:**

   ```bash
   cd apps/web
   pnpm dev
   ```

   Open `http://localhost:5173` in a browser.

5. **End‑to‑end flow:**

   - Sign up on `/auth/signup`.  
   - You should be redirected to `/app`.  
   - Create a new conversation from the sidebar.  
   - Type into the message box and send.  
   - Watch assistant tokens stream in real time.

If all steps complete successfully, you now have a fully functional, visually modern, streaming AI chat web app.

---

## 10.11. Next Steps

Upcoming markdown files can extend this frontend with:

- **Settings drawer** for per‑conversation temperature/model adjustments.  
- **Usage indicators** and per‑org analytics views, wired to Grafana‑ready metrics.  
- **Tool / plugin UI** (tool invocation traces, inspector panels).

> **AI Agent Instruction:**  
> Before moving on, ensure that `pnpm dev --filter=api-gateway` and `pnpm dev` in `apps/web` produce a stable, responsive UI without TypeScript or runtime errors.

---

_End of 10.md – Web Chat App – Material 3 UI & Streaming Chat_
