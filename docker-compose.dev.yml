# docker-compose.dev.yml
# Development overrides for Docker Compose
# Docker Compose için geliştirme geçersiz kılmaları

version: '3.9'

services:
  # Development-specific API Gateway configuration
  # Geliştirmeye özel API Gateway yapılandırması
  api-gateway:
    build:
      context: .
      dockerfile: apps/api-gateway/Dockerfile
      target: build  # Use build stage for development
    environment:
      SKIP_DOTENV: "1"
      NODE_ENV: development
      LOG_LEVEL: debug
      DATABASE_URL: postgresql://ai_chat_user:ai_chat_password@db:5432/ai_chat_db?schema=public
      REDIS_URL: redis://redis:6379
      JWT_SECRET: ${JWT_SECRET:-0bCY34ghxI5HtVOzkti8fIfqP3iE2a5z}
      API_PORT: "8080"
      API_HOST: "0.0.0.0"
      OLLAMA_BASE_URL: http://ollama:11434
    volumes:
      # Mount source code for hot reload (Bun supports hot reload natively)
      # Hot reload için kaynak kodu bağla (Bun yerel olarak hot reload destekler)
      - ./apps/api-gateway/src:/app/apps/api-gateway/src:ro
      - ./packages:/app/packages:ro
    ports:
      - '8080:8080'
      - '9229:9229'  # Bun debug port (compatible with Node.js debug protocol)
    command: ["bun", "run", "apps/api-gateway/src/main.ts"]

  # Development-specific Web configuration
  # Geliştirmeye özel Web yapılandırması
  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
      target: build  # Use build stage for development
    environment:
      NODE_ENV: development
      API_BASE_URL: http://localhost:8080
    volumes:
      # Mount source code for hot reload
      # Hot reload için kaynak kodu bağla
      - ./apps/web/src:/app/apps/web/src:ro
    ports:
      - '3002:5173'  # Vite dev server port (changed from 3001 due to conflict)
    command: ["sh", "-c", "cd apps/web && bun run dev --host 0.0.0.0"]

  # Development-specific Next.js Web App configuration
  # Geliştirmeye özel Next.js Web App yapılandırması
  web-app:
    build:
      context: .
      dockerfile: apps/web-app/Dockerfile
      target: builder  # Use builder stage for development
      args:
        NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL:-http://localhost:8080}
    environment:
      NODE_ENV: development
      NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL:-http://localhost:8080}
      PORT: 3000
      HOSTNAME: "0.0.0.0"
    volumes:
      # Mount source code for hot reload (rw for Next.js .next directory)
      # Hot reload için kaynak kodu bağla (Next.js .next dizini için rw)
      - ./apps/web-app:/app/apps/web-app
      - ./packages:/app/packages:ro
    ports:
      - '3000:3000'
      - '9230:9229'  # Debug port (mapped to 9230 to avoid conflict)
    command: ["sh", "-c", "cd apps/web-app && bun run dev"]

  # Development-specific Worker Jobs configuration
  # Geliştirmeye özel Worker Jobs yapılandırması
  worker-jobs:
    build:
      context: .
      dockerfile: apps/worker-jobs/Dockerfile
      target: build  # Use build stage for development
    environment:
      SKIP_DOTENV: "1"
      NODE_ENV: development
      LOG_LEVEL: debug
      WORKER_CONCURRENCY: 5
      DATABASE_URL: postgresql://ai_chat_user:ai_chat_password@db:5432/ai_chat_db?schema=public
      REDIS_URL: redis://redis:6379
      JWT_SECRET: ${JWT_SECRET:-0bCY34ghxI5HtVOzkti8fIfqP3iE2a5z}
    volumes:
      # Mount source code for development
      # Geliştirme için kaynak kodu bağla
      - ./apps/worker-jobs/src:/app/apps/worker-jobs/src:ro
      - ./packages:/app/packages:ro
    command: ["bun", "run", "apps/worker-jobs/src/main.ts"]

  # Development database with more verbose logging
  # Daha ayrıntılı loglama ile geliştirme veritabanı
  db:
    environment:
      POSTGRES_LOG_STATEMENT: all
      POSTGRES_LOG_DURATION: 'true'

  # Development Redis with persistence disabled for faster restarts
  # Daha hızlı yeniden başlatmalar için kalıcılık devre dışı geliştirme Redis
  redis:
    command: redis-server --appendonly no

